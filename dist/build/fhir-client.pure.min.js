(()=>{var e={7946:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(3458),a=r(2612),o=r(628),{Response:i}=window,s=n.debug.extend("client");function c(e,t,r,a,o){let i=n.makeArray(t.resolveReferences).filter(Boolean).map((e=>String(e).trim())).filter(Boolean);if(i=i.filter(((e,t)=>!(i.indexOf(e,t+1)>-1&&(s('Duplicated reference path "%s"',e),1)))),!i.length)return Promise.resolve();const c={};i.forEach((e=>{const t=e.split(".").length;c[t]||(c[t]=[]),c[t].push(e)}));let d=Promise.resolve();return Object.keys(c).sort().forEach((i=>{const s=c[i];d=d.then((()=>Promise.all(s.map((i=>function(e,t,r,a,o,i){const s=n.getPath(e,t);if(s){const c=Array.isArray(s);return Promise.all(n.makeArray(s).filter(Boolean).map(((s,d)=>{const u=s.reference;if(u)return function(e,t,r,n){return t[e]||(t[e]=r.request({url:e,signal:n}).then((r=>(t[e]=r,r)),(r=>{throw delete t[e],r}))),Promise.resolve(t[e])}(u,a,o,i).then((a=>{r&&(c?t.indexOf("..")>-1?n.setPath(e,`${t.replace("..",`.${d}.`)}`,a):n.setPath(e,`${t}.${d}`,a):n.setPath(e,t,a))})).catch((e=>{if(404!==e.status)throw e}))})))}}(e,i,!!t.graph,r,a,o))))))})),d}t.default=class{constructor(e,t){this.units=n.units;const r="string"==typeof t?{serverUrl:t}:t;n.assert(r.serverUrl&&r.serverUrl.match(/https?:\/\/.+/),'A "serverUrl" option is required and must begin with "http(s)"'),this.state=r,this.environment=e,this._refreshTask=null;const a=this;this.patient={get id(){return a.getPatientId()},read:e=>{const t=this.patient.id;return t?this.request({...e,url:`Patient/${t}`}):Promise.reject(new Error("Patient is not available"))},request:(e,t={})=>this.patient.id?(async()=>{const r=await async function(e,t){const r=n.absolute("/",t.state.serverUrl);async function a(e){const r=e.pathname.split("/").pop();n.assert(r,`Invalid url "${e}"`),n.assert(o.patientCompartment.indexOf(r)>-1,`Cannot filter "${r}" resources by patient`);const a=await n.fetchConformanceStatement(t.state.serverUrl),i=n.getPatientParam(a,r);return e.searchParams.set(i,t.patient.id),e.href}return"string"==typeof e||e instanceof URL?{url:await a(new URL(e+"",r))}:(e.url=await a(new URL(e.url+"",r)),e)}(e,this);return this.request(r,t)})():Promise.reject(new Error("Patient is not available"))},this.encounter={get id(){return a.getEncounterId()},read:e=>{const t=this.encounter.id;return t?this.request({...e,url:`Encounter/${t}`}):Promise.reject(new Error("Encounter is not available"))}},this.user={get fhirUser(){return a.getFhirUser()},get id(){return a.getUserId()},get resourceType(){return a.getUserType()},read:e=>{const t=this.user.fhirUser;return t?this.request({...e,url:t}):Promise.reject(new Error("User is not available"))}},this.connect(e.fhir)}connect(e){if("function"==typeof e){const t={baseUrl:this.state.serverUrl.replace(/\/$/,"")},r=this.getState("tokenResponse.access_token");if(r)t.auth={token:r};else{const{username:e,password:r}=this.state;e&&r&&(t.auth={user:e,pass:r})}this.api=e(t);const n=this.getState("tokenResponse.patient");n&&(this.patient.api=e({...t,patient:n}))}return this}getPatientId(){const e=this.state.tokenResponse;return e?e.patient?e.patient:((this.state.scope||"").match(/\blaunch(\/patient)?\b/)?s("The ID of the selected patient is not available. Please check if your server supports that."):s(a.default.noScopeForId,"patient","patient"),null):(this.state.authorizeUri?s(a.default.noIfNoAuth,"the ID of the selected patient"):s(a.default.noFreeContext,"selected patient"),null)}getEncounterId(){const e=this.state.tokenResponse;return e?e.encounter?e.encounter:((this.state.scope||"").match(/\blaunch(\/encounter)?\b/)?s("The ID of the selected encounter is not available. Please check if your server supports that, and that the selected patient has any recorded encounters."):s(a.default.noScopeForId,"encounter","encounter"),null):(this.state.authorizeUri?s(a.default.noIfNoAuth,"the ID of the selected encounter"):s(a.default.noFreeContext,"selected encounter"),null)}getIdToken(){const e=this.state.tokenResponse;if(e){const t=e.id_token,r=this.state.scope||"";if(!t){const e=r.match(/\bopenid\b/),t=r.match(/\bprofile\b/),n=r.match(/\bfhirUser\b/);return s(e&&(n||t)?"The id_token is not available. Please check if your server supports that.":"You are trying to get the id_token but you are not using the right scopes. Please add 'openid' and 'fhirUser' or 'profile' to the scopes you are requesting."),null}return n.jwtDecode(t,this.environment)}return this.state.authorizeUri?s(a.default.noIfNoAuth,"the id_token"):s(a.default.noFreeContext,"id_token"),null}getFhirUser(){const e=this.getIdToken();return e?e.fhirUser?e.fhirUser.split("/").slice(-2).join("/"):e.profile:null}getUserId(){const e=this.getFhirUser();return e?e.split("/")[1]:null}getUserType(){const e=this.getFhirUser();return e?e.split("/")[0]:null}getAuthorizationHeader(){const e=this.getState("tokenResponse.access_token");if(e)return"Bearer "+e;const{username:t,password:r}=this.state;return t&&r?"Basic "+this.environment.btoa(t+":"+r):null}async _clearState(){const e=this.environment.getStorage(),t=await e.get(o.SMART_KEY);t&&await e.unset(t),await e.unset(o.SMART_KEY),this.state.tokenResponse={}}create(e,t){return this.request({...t,url:`${e.resourceType}`,method:"POST",body:JSON.stringify(e),headers:{"Content-Type":"application/json",...(t||{}).headers}})}update(e,t){return this.request({...t,url:`${e.resourceType}/${e.id}`,method:"PUT",body:JSON.stringify(e),headers:{"Content-Type":"application/json",...(t||{}).headers}})}delete(e,t={}){return this.request({...t,url:e,method:"DELETE"})}async patch(e,t,r={}){return n.assertJsonPatch(t),this.request({...r,url:e,method:"PATCH",body:JSON.stringify(t),headers:{prefer:"return=presentation","content-type":"application/json-patch+json; charset=UTF-8",...r.headers}})}async request(e,t={},r={}){var o;const s=n.debug.extend("client:request");let d;n.assert(e,"request requires an url or request options as argument"),"string"==typeof e||e instanceof URL?(d=String(e),e={}):d=String(e.url),d=n.absolute(d,this.state.serverUrl);const u={graph:!1!==t.graph,flat:!!t.flat,pageLimit:null!==(o=t.pageLimit)&&void 0!==o?o:1,resolveReferences:t.resolveReferences||[],useRefreshToken:!1!==t.useRefreshToken,onPage:"function"==typeof t.onPage?t.onPage:void 0},l=e.signal||void 0;let p;return(u.useRefreshToken?this.refreshIfNeeded({signal:l}).then((()=>e)):Promise.resolve(e)).then((e=>{const t=this.getAuthorizationHeader();return t&&(e.headers={...e.headers,Authorization:t}),e})).then((e=>(s("%s, options: %O, fhirOptions: %O",d,e,u),n.request(d,e).then((t=>e.includeResponse?(p=t.response,t.body):t))))).catch((async e=>{if(401==e.status){if(!this.getState("tokenResponse.access_token"))throw e.message+="\nThis app cannot be accessed directly. Please launch it as SMART app!",e;if(!u.useRefreshToken)throw s("Your session has expired and the useRefreshToken option is set to false. Please re-launch the app."),await this._clearState(),e.message+="\n"+a.default.expired,e;throw s("Auto-refresh failed! Please re-launch the app."),await this._clearState(),e.message+="\n"+a.default.expired,e}throw e})).catch((e=>{throw 403==e.status&&s("Permission denied! Please make sure that you have requested the proper scopes."),e})).then((t=>t?"string"==typeof t||t instanceof i?t:(async e=>("Bundle"==e.resourceType?await Promise.all((e.entry||[]).map((e=>c(e.resource,u,r,this,l)))):await c(e,u,r,this,l),e))(t).then((async e=>{if(e&&"Bundle"==e.resourceType){const t=e.link||[];if(u.flat&&(e=(e.entry||[]).map((e=>e.resource))),u.onPage&&await u.onPage(e,{...r}),--u.pageLimit){const a=t.find((e=>"next"==e.relation));if(e=n.makeArray(e),a&&a.url){const t=await this.request({url:a.url,signal:l},u,r);return u.onPage?null:u.resolveReferences.length?(Object.assign(r,t.references),e.concat(n.makeArray(t.data||t))):e.concat(n.makeArray(t))}}}return e})).then((e=>{if(u.graph)r={};else if(!u.onPage&&u.resolveReferences.length)return{data:e,references:r};return e})).then((t=>e.includeResponse?{body:t,response:p}:t)):t))}refreshIfNeeded(e={}){const t=this.getState("tokenResponse.access_token"),r=this.getState("tokenResponse.refresh_token"),n=this.state.expiresAt||0;return t&&r&&n-10<Date.now()/1e3?this.refresh(e):Promise.resolve(this.state)}refresh(e={}){var t,r;const a=n.debug.extend("client:refresh");a("Attempting to refresh with refresh_token...");const o=null===(r=null===(t=this.state)||void 0===t?void 0:t.tokenResponse)||void 0===r?void 0:r.refresh_token;n.assert(o,"Unable to refresh. No refresh_token found.");const i=this.state.tokenUri;n.assert(i,"Unable to refresh. No tokenUri found.");const s=this.getState("tokenResponse.scope")||"",c=s.search(/\boffline_access\b/)>-1,d=s.search(/\bonline_access\b/)>-1;if(n.assert(c||d,"Unable to refresh. No offline_access or online_access scope found."),!this._refreshTask){const t={credentials:this.environment.options.refreshTokenWithCredentials||"same-origin",...e,method:"POST",mode:"cors",headers:{...e.headers||{},"content-type":"application/x-www-form-urlencoded"},body:`grant_type=refresh_token&refresh_token=${encodeURIComponent(o)}`};if(!("authorization"in t.headers)){const{clientSecret:e,clientId:r}=this.state;e&&(t.headers.authorization="Basic "+this.environment.btoa(r+":"+e))}this._refreshTask=n.request(i,t).then((e=>(n.assert(e.access_token,"No access token received"),a("Received new access token response %O",e),Object.assign(this.state.tokenResponse,e),this.state.expiresAt=n.getAccessTokenExpiration(e,this.environment),this.state))).catch((e=>{var t,r;throw(null===(r=null===(t=this.state)||void 0===t?void 0:t.tokenResponse)||void 0===r?void 0:r.refresh_token)&&(a("Deleting the expired or invalid refresh token."),delete this.state.tokenResponse.refresh_token),e})).finally((()=>{this._refreshTask=null;const e=this.state.key;e?this.environment.getStorage().set(e,this.state):a("No 'key' found in Clint.state. Cannot persist the instance.")}))}return this._refreshTask}byCode(e,t){return n.byCode(e,t)}byCodes(e,t){return n.byCodes(e,t)}getPath(e,t=""){return n.getPath(e,t)}getState(e=""){return n.getPath({...this.state},e)}getFhirVersion(){return n.fetchConformanceStatement(this.state.serverUrl).then((e=>e.fhirVersion))}getFhirRelease(){return this.getFhirVersion().then((e=>{var t;return null!==(t=o.fhirVersions[e])&&void 0!==t?t:0}))}}},5685:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});class r extends Error{constructor(e){super(`${e.status} ${e.statusText}\nURL: ${e.url}`),this.name="HttpError",this.response=e,this.statusCode=e.status,this.status=e.status,this.statusText=e.statusText}async parse(){if(!this.response.bodyUsed)try{const e=this.response.headers.get("Content-Type")||"text/plain";if(e.match(/\bjson\b/i)){let e=await this.response.json();e.error?(this.message+="\n"+e.error,e.error_description&&(this.message+=": "+e.error_description)):this.message+="\n\n"+JSON.stringify(e,null,4)}else if(e.match(/^text\//i)){let e=await this.response.text();e&&(this.message+="\n\n"+e)}}catch{}return this}toJSON(){return{name:this.name,statusCode:this.statusCode,status:this.status,statusText:this.statusText,message:this.message}}}t.default=r},2254:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(9349),a=r(7946),o=r(5424);t.default=class{constructor(e={}){this._url=null,this._storage=null,this.options={replaceBrowserHistory:!0,fullSessionStorageSupport:!0,refreshTokenWithCredentials:"same-origin",...e}}relative(e){return new URL(e,this.getUrl().href).href}get fhir(){return"function"==typeof fhir?fhir:null}getUrl(){return this._url||(this._url=new URL(location+"")),this._url}redirect(e){location.href=e}getStorage(){return this._storage||(this._storage=new o.default),this._storage}getAbortController(){return AbortController}atob(e){return window.atob(e)}btoa(e){return window.btoa(e)}getSmartApi(){return{ready:(...e)=>n.ready(this,...e),authorize:e=>n.authorize(this,e),init:e=>n.init(this,e),client:e=>new a.default(this,e),options:this.options}}}},1769:(e,t,r)=>{"use strict";const n=new(r(2254).default),{ready:a,authorize:o,init:i,client:s,options:c}=n.getSmartApi(),d={AbortController:window.AbortController,client:s,oauth2:{settings:c,ready:a,authorize:o,init:i}};e.exports=d},3458:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.assertJsonPatch=t.assert=t.getTargetWindow=t.getPatientParam=t.byCodes=t.byCode=t.getAccessTokenExpiration=t.getTimeInFuture=t.jwtDecode=t.randomString=t.absolute=t.makeArray=t.setPath=t.getPath=t.fetchConformanceStatement=t.getAndCache=t.request=t.responseToJSON=t.checkResponse=t.units=t.debug=void 0;const n=r(5685),a=r(628),o=r(1227),{fetch:i}=window,s=o("FHIR");t.debug=s;const c={};function d({value:e,code:t}){if("number"!=typeof e)throw new Error("Found a non-numerical unit: "+e+" "+t)}async function u(e){if(!e.ok){const t=new n.default(e);throw await t.parse(),t}return e}function l(e){return e.text().then((e=>e.length?JSON.parse(e):""))}function p(e,t={}){const{includeResponse:r,...n}=t;return i(e,{mode:"cors",...n,headers:{accept:"application/json",...n.headers}}).then(u).then((e=>{const t=e.headers.get("Content-Type")+"";return t.match(/\bjson\b/i)?l(e).then((t=>({res:e,body:t}))):t.match(/^text\//i)?e.text().then((t=>({res:e,body:t}))):{res:e}})).then((({res:e,body:t})=>{if(!t&&201==e.status){const t=e.headers.get("location");if(t)return p(t,{...n,method:"GET",body:null,includeResponse:r})}return r?{body:t,response:e}:void 0===t?e:t}))}function h(e,t,r=!1){return r||!c[e]?(c[e]=p(e,t),c[e]):Promise.resolve(c[e])}function f(e,t=""){if(!(t=t.trim()))return e;let r=t.split("."),n=e;for(;n&&r.length;){const e=r.shift();if(!e&&Array.isArray(n))return n.map((e=>f(e,r.join("."))));n=n[e]}return n}function y(e){return Array.isArray(e)?e:[e]}function w(e,t){const r=e.split(".")[1];return r?JSON.parse(t.atob(r)):null}function g(e,t){const r={};function n(e,t){e&&Array.isArray(e.coding)&&e.coding.forEach((({code:e})=>{e&&(r[e]=r[e]||[],r[e].push(t))}))}return y(e).forEach((e=>{"Observation"===e.resourceType&&e[t]&&(Array.isArray(e[t])?e[t].forEach((t=>n(t,e))):n(e[t],e))})),r}function m(e,t){if(!e)throw new Error(t)}t.units={cm({code:e,value:t}){if(d({code:e,value:t}),"cm"==e)return t;if("m"==e)return 100*t;if("in"==e)return 2.54*t;if("[in_us]"==e)return 2.54*t;if("[in_i]"==e)return 2.54*t;if("ft"==e)return 30.48*t;if("[ft_us]"==e)return 30.48*t;throw new Error("Unrecognized length unit: "+e)},kg({code:e,value:t}){if(d({code:e,value:t}),"kg"==e)return t;if("g"==e)return t/1e3;if(e.match(/lb/))return t/2.20462;if(e.match(/oz/))return t/35.274;throw new Error("Unrecognized weight unit: "+e)},any:e=>(d(e),e.value)},t.checkResponse=u,t.responseToJSON=l,t.request=p,t.getAndCache=h,t.fetchConformanceStatement=function(e="/",t){const r=String(e).replace(/\/*$/,"/")+"metadata";return h(r,t).catch((e=>{throw new Error(`Failed to fetch the conformance statement from "${r}". ${e}`)}))},t.getPath=f,t.setPath=function(e,t,r,n=!1){return t.trim().split(".").reduce(((e,t,a,o)=>{if(!e||a!==o.length-1)return e&&void 0===e[t]&&n&&(e[t]=o[a+1].match(/^[0-9]+$/)?[]:{}),e?e[t]:void 0;e[t]=r}),e),e},t.makeArray=y,t.absolute=function(e,t){return e.match(/^http/)||e.match(/^urn/)?e:String(t||"").replace(/\/+$/,"")+"/"+e.replace(/^\/+/,"")},t.randomString=function(e=8,t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"){const r=[],n=t.length;for(;e--;)r.push(t.charAt(Math.floor(Math.random()*n)));return r.join("")},t.jwtDecode=w,t.getTimeInFuture=function(e=120,t=new Date){return Math.floor(t.getTime()/1e3+e)},t.getAccessTokenExpiration=function(e,t){const r=Math.floor(Date.now()/1e3);if(e.expires_in)return r+e.expires_in;if(e.access_token){let r=w(e.access_token,t);if(r&&r.exp)return r.exp}return r+300},t.byCode=g,t.byCodes=function(e,t){const r=g(e,t);return(...e)=>e.filter((e=>e+""in r)).reduce(((e,t)=>e.concat(r[t+""])),[])},t.getPatientParam=function(e,t){const r=(f(e,"rest.0.resource")||[]).find((e=>e.type===t));if(!r)throw new Error(`Resource "${t}" is not supported by this FHIR server`);if(!Array.isArray(r.searchParam))throw new Error(`No search parameters supported for "${t}" on this FHIR server`);if("Patient"==t&&r.searchParam.find((e=>"_id"==e.name)))return"_id";const n=a.patientParams.find((e=>r.searchParam.find((t=>t.name==e))));if(!n)throw new Error("I don't know what param to use for "+t);return n},t.getTargetWindow=async function(e,t=800,r=720){if("function"==typeof e&&(e=await e()),e&&"object"==typeof e)return e;if("string"!=typeof e)return s("Invalid target type '%s'. Failing back to '_self'.",typeof e),self;if("_self"==e)return self;if("_parent"==e)return parent;if("_top"==e)return top;if("_blank"==e){let e,t=null;try{if(t=window.open("","SMARTAuthPopup"),!t)throw new Error("Perhaps window.open was blocked")}catch(t){e=t}return t||(s("Cannot open window. Failing back to '_self'. %s",e),self)}if("popup"==e){let e,n=null;try{if(n=window.open("","SMARTAuthPopup",["height="+r,"width="+t,"menubar=0","resizable=1","status=0","top="+(screen.height-r)/2,"left="+(screen.width-t)/2].join(",")),!n)throw new Error("Perhaps the popup window was blocked")}catch(t){e=t}return n||(s("Cannot open window. Failing back to '_self'. %s",e),self)}return frames[e]||(s("Unknown target '%s'. Failing back to '_self'.",e),self)},t.assert=m,t.assertJsonPatch=function(e){m(Array.isArray(e),"The JSON patch must be an array"),m(e.length>0,"The JSON patch array should not be empty"),e.forEach((e=>{m(["add","replace","test","move","copy","remove"].indexOf(e.op)>-1,'Each patch operation must have an "op" property which must be one of: "add", "replace", "test", "move", "copy", "remove"'),m(e.path&&typeof e.path,`Invalid "${e.op}" operation. Missing "path" property`),"add"==e.op||"replace"==e.op||"test"==e.op?(m("value"in e,`Invalid "${e.op}" operation. Missing "value" property`),m(3==Object.keys(e).length,`Invalid "${e.op}" operation. Contains unknown properties`)):"move"==e.op||"copy"==e.op?(m("string"==typeof e.from,`Invalid "${e.op}" operation. Requires a string "from" property`),m(3==Object.keys(e).length,`Invalid "${e.op}" operation. Contains unknown properties`)):m(2==Object.keys(e).length,`Invalid "${e.op}" operation. Contains unknown properties`)}))}},1405:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.signCompactJws=t.importKey=t.generatePKCEChallenge=t.randomBytes=t.digestSha256=t.base64urlencode=t.base64urldecode=void 0;const n=r(7277),a=n.base64url.encode;t.base64urlencode=a;const o=n.base64url.decode;let i;t.base64urldecode=o,i=window.crypto.subtle,t.digestSha256=async e=>{let t;t="string"==typeof e?(new TextEncoder).encode(e).buffer:e;const r=await i.digest("SHA-256",t);return new Uint8Array(r)},t.randomBytes=e=>{var t;return"undefined"!=typeof window&&(null===(t=null===window||void 0===window?void 0:window.crypto)||void 0===t?void 0:t.getRandomValues)?window.crypto.getRandomValues(new Uint8Array(e)):(void 0)(e)},t.generatePKCEChallenge=async(e=96)=>{const r=t.randomBytes(e),n=a(r);return{codeChallenge:a(await t.digestSha256(n)),codeVerifier:n}},t.importKey=async e=>n.importJWK(e),t.signCompactJws=async(e,t,r,a)=>new n.SignJWT(a).setProtectedHeader({...r,alg:e}).sign(t)},628:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SMART_KEY=t.patientParams=t.fhirVersions=t.patientCompartment=void 0,t.patientCompartment=["Account","AdverseEvent","AllergyIntolerance","Appointment","AppointmentResponse","AuditEvent","Basic","BodySite","BodyStructure","CarePlan","CareTeam","ChargeItem","Claim","ClaimResponse","ClinicalImpression","Communication","CommunicationRequest","Composition","Condition","Consent","Coverage","CoverageEligibilityRequest","CoverageEligibilityResponse","DetectedIssue","DeviceRequest","DeviceUseRequest","DeviceUseStatement","DiagnosticOrder","DiagnosticReport","DocumentManifest","DocumentReference","EligibilityRequest","Encounter","EnrollmentRequest","EpisodeOfCare","ExplanationOfBenefit","FamilyMemberHistory","Flag","Goal","Group","ImagingManifest","ImagingObjectSelection","ImagingStudy","Immunization","ImmunizationEvaluation","ImmunizationRecommendation","Invoice","List","MeasureReport","Media","MedicationAdministration","MedicationDispense","MedicationOrder","MedicationRequest","MedicationStatement","MolecularSequence","NutritionOrder","Observation","Order","Patient","Person","Procedure","ProcedureRequest","Provenance","QuestionnaireResponse","ReferralRequest","RelatedPerson","RequestGroup","ResearchSubject","RiskAssessment","Schedule","ServiceRequest","Specimen","SupplyDelivery","SupplyRequest","VisionPrescription"],t.fhirVersions={"0.4.0":2,"0.5.0":2,"1.0.0":2,"1.0.1":2,"1.0.2":2,"1.1.0":3,"1.4.0":3,"1.6.0":3,"1.8.0":3,"3.0.0":3,"3.0.1":3,"3.3.0":4,"3.5.0":4,"4.0.0":4,"4.0.1":4},t.patientParams=["patient","subject","requester","member","actor","beneficiary"],t.SMART_KEY="SMART_KEY"},9349:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.init=t.ready=t.buildTokenRequest=t.completeAuth=t.onMessage=t.isInPopUp=t.isInFrame=t.authorize=t.getSecurityExtensions=t.fetchWellKnownJson=t.KEY=void 0;const n=r(3458),a=r(7946),o=r(628);Object.defineProperty(t,"KEY",{enumerable:!0,get:function(){return o.SMART_KEY}});const i=r(1405),s=n.debug.extend("oauth2");function c(){return"object"==typeof window}function d(e="/",t){const r=String(e).replace(/\/*$/,"/")+".well-known/smart-configuration";return n.getAndCache(r,t).catch((e=>{throw new Error(`Failed to fetch the well-known json "${r}". ${e.message}`)}))}function u(e,t="/"){return console.log("Getting sec extension",t),function(e="/",t){return d(e,void 0).then((e=>{if(!e.authorization_endpoint||!e.token_endpoint)throw new Error("Invalid wellKnownJson");return{registrationUri:e.registration_endpoint||"",authorizeUri:e.authorization_endpoint,tokenUri:e.token_endpoint,codeChallengeMethods:e.code_challenge_methods_supported||[]}}))}(t).catch((e=>function(e="/",t){return n.fetchConformanceStatement(e,t).then((e=>{const t=(n.getPath(e||{},"rest.0.security.extension")||[]).filter((e=>"http://fhir-registry.smarthealthit.org/StructureDefinition/oauth-uris"===e.url)).map((e=>e.extension))[0],r={registrationUri:"",authorizeUri:"",tokenUri:"",codeChallengeMethods:[]};return t&&t.forEach((e=>{"register"===e.url&&(r.registrationUri=e.valueUri),"authorize"===e.url&&(r.authorizeUri=e.valueUri),"token"===e.url&&(r.tokenUri=e.valueUri)})),r}))}(t)))}async function l(e,t={}){const r=e.getUrl();if(Array.isArray(t)){const a=r.searchParams.get("iss")||r.searchParams.get("fhirServiceUrl");if(!a)throw new Error('Passing in an "iss" url parameter is required if authorize uses multiple configurations');const o=t.find((e=>{if(e.issMatch){if("function"==typeof e.issMatch)return!!e.issMatch(a);if("string"==typeof e.issMatch)return e.issMatch===a;if(e.issMatch instanceof RegExp)return e.issMatch.test(a)}return!1}));return n.assert(o,`No configuration found matching the current "iss" parameter "${a}"`),await l(e,o)}const{redirect_uri:a,clientSecret:d,clientPrivateJwk:y,fakeTokenResponse:w,patientId:g,encounterId:m,client_id:S,target:E,width:v,height:A,pkceMode:b}=t;let{iss:C,launch:_,fhirServiceUrl:J,redirectUri:P,noRedirect:k,scope:W="",clientId:K,completeInTarget:H}=t;const I=e.getStorage();C=r.searchParams.get("iss")||C,J=r.searchParams.get("fhirServiceUrl")||J,_=r.searchParams.get("launch")||_,K||(K=S),P||(P=a),P?P.match(/^https?\:\/\//)||(P=e.relative(P)):P=e.relative(".");const T=String(C||J||"");if(!T)throw new Error("No server url found. It must be specified as `iss` or as `fhirServiceUrl` parameter");if(C&&s("Making %s launch...",_?"EHR":"standalone"),_&&!W.match(/launch/)&&(W+=" launch"),c()){const e=p(),t=h();(e||t)&&!0!==H&&!1!==H&&(H=e,console.warn('Your app is being authorized from within an iframe or popup window. Please be explicit and provide a "completeInTarget" option. Use "true" to complete the authorization in the same window, or "false" to try to complete it in the parent or the opener window. See http://docs.smarthealthit.org/client-js/api.html'))}const R=await I.get(o.SMART_KEY);await I.unset(R);const U=n.randomString(16),O={clientId:K,scope:W,redirectUri:P,serverUrl:T,clientSecret:d,clientPrivateJwk:y,tokenResponse:{},key:U,completeInTarget:H};(!c()||n.getPath(e,"options.fullSessionStorageSupport"))&&await I.set(o.SMART_KEY,U),w&&Object.assign(O.tokenResponse,w),g&&Object.assign(O.tokenResponse,{patient:g}),m&&Object.assign(O.tokenResponse,{encounter:m});let D=P+"?state="+encodeURIComponent(U);if(J&&!C)return s("Making fake launch..."),await I.set(U,O),k?D:await e.redirect(D);const x=await u(0,T);if(Object.assign(O,x),await I.set(U,O),!O.authorizeUri)return k?D:await e.redirect(D);const M=["response_type=code","client_id="+encodeURIComponent(K||""),"scope="+encodeURIComponent(W),"redirect_uri="+encodeURIComponent(P),"aud="+encodeURIComponent(T),"state="+encodeURIComponent(U)];if(_&&M.push("launch="+encodeURIComponent(_)),"required"===b&&!x.codeChallengeMethods.includes("S256"))throw new Error("Required PKCE code challenge method (`S256`) was not found.");if("disabled"!==b&&x.codeChallengeMethods.includes("S256")){let e=await i.generatePKCEChallenge();Object.assign(O,e),await I.set(U,O),M.push("code_challenge="+O.codeChallenge),M.push("code_challenge_method=S256")}if(D=O.authorizeUri+"?"+M.join("&"),k)return D;if(!E||!c())return await e.redirect(D);{let e;if(e=await n.getTargetWindow(E,v,A),e!==self)try{e.sessionStorage.removeItem(R),e.sessionStorage.setItem(U,JSON.stringify(O))}catch(t){n.debug('Failed to modify window.sessionStorage. Perhaps it is from different origin?. Failing back to "_self". %s',t),e=self}if(e!==self)try{e.location.href=D,self.addEventListener("message",f)}catch(e){n.debug('Failed to modify window.location. Perhaps it is from different origin?. Failing back to "_self". %s',e),self.location.href=D}else self.location.href=D}}function p(){try{return self!==top&&parent!==self}catch(e){return!0}}function h(){try{return self===top&&!!opener&&opener!==self&&!!window.name}catch(e){return!1}}function f(e){"completeAuth"==e.data.type&&e.origin===new URL(self.location.href).origin&&(window.removeEventListener("message",f),window.location.href=e.data.url)}async function y(e){var t,r;const i=e.getUrl(),d=e.getStorage(),u=i.searchParams;let l=u.get("state");const f=u.get("code"),y=u.get("error"),g=u.get("error_description");if(l||(l=await d.get(o.SMART_KEY)),y||g)throw new Error([y,g].filter(Boolean).join(": "));s("key: %s, code: %s",l,f),n.assert(l,"No 'state' parameter found. Please (re)launch the app.");let m=await d.get(l);const S=!c()||n.getPath(e,"options.fullSessionStorageSupport");if(c()&&m&&!m.completeInTarget){const e=p(),t=h();if((e||t)&&!i.searchParams.get("complete")){i.searchParams.set("complete","1");const{href:r,origin:n}=i;return e&&parent.postMessage({type:"completeAuth",url:r},n),t&&(opener.postMessage({type:"completeAuth",url:r},n),window.close()),new Promise((()=>{}))}}i.searchParams.delete("complete");const E=u.has("state");if(c()&&n.getPath(e,"options.replaceBrowserHistory")&&(f||E)&&(f&&(u.delete("code"),s("Removed code parameter from the url.")),E&&S&&(u.delete("state"),s("Removed state parameter from the url.")),window.history.replaceState&&window.history.replaceState({},"",i.href)),n.assert(m,"No state found! Please (re)launch the app."),f&&!(null===(t=m.tokenResponse)||void 0===t?void 0:t.access_token)&&m.tokenUri){n.assert(f,"'code' url parameter is required"),s("Preparing to exchange the code for access token...");const t=await w(e,f,m);s("Token request options: %O",t);const r=await n.request(m.tokenUri,t);s("Token response: %O",r),n.assert(r.access_token,"Failed to obtain access token."),m.expiresAt=n.getAccessTokenExpiration(r,e),m={...m,tokenResponse:r},await d.set(l,m),s("Authorization successful!")}else s((null===(r=m.tokenResponse)||void 0===r?void 0:r.access_token)?"Already authorized":"No authorization needed");S&&await d.set(o.SMART_KEY,l);const v=new a.default(e,m);return s("Created client instance: %O",v),v}async function w(e,t,r){const{redirectUri:a,clientSecret:o,clientPublicKeySetUrl:c,clientPrivateJwk:d,tokenUri:u,clientId:l,codeVerifier:p}=r;n.assert(a,"Missing state.redirectUri"),n.assert(u,"Missing state.tokenUri"),n.assert(l,"Missing state.clientId");const h={method:"POST",headers:{"content-type":"application/x-www-form-urlencoded"},body:`code=${t}&grant_type=authorization_code&redirect_uri=${encodeURIComponent(a)}`};if(o)h.headers.Authorization="Basic "+e.btoa(l+":"+o),s("Using state.clientSecret to construct the authorization header: %s",h.headers.Authorization);else if(d){const e=await i.importKey(d),t={typ:"JWT",kid:d.kid,jku:c},r={iss:l,sub:l,aud:u,jti:i.base64urlencode(i.randomBytes(32)),exp:n.getTimeInFuture(120)},a=await i.signCompactJws(d.alg,e,t,r);h.body+=`&client_assertion_type=${encodeURIComponent("urn:ietf:params:oauth:client-assertion-type:jwt-bearer")}`,h.body+=`&client_assertion=${encodeURIComponent(a)}`,s("Using state.clientPrivateJwk to add a client_assertion to the POST body")}else s("Public client detected; adding state.clientId to the POST body"),h.body+=`&client_id=${encodeURIComponent(l)}`;return p&&(s("Found state.codeVerifier, adding to the POST body"),h.body+="&code_verifier="+p),h}t.fetchWellKnownJson=d,t.getSecurityExtensions=u,t.authorize=l,t.isInFrame=p,t.isInPopUp=h,t.onMessage=f,t.completeAuth=y,t.buildTokenRequest=w,t.ready=async function(e,t,r){let n=y(e);return t&&(n=n.then(t)),r&&(n=n.catch(r)),n},t.init=async function(e,t){const r=e.getUrl(),n=r.searchParams.get("code"),i=r.searchParams.get("state");if(n&&i)return y(e);const s=e.getStorage(),c=i||await s.get(o.SMART_KEY),d=await s.get(c);return d?new a.default(e,d):l(e,t).then((()=>new Promise((()=>{}))))}},5424:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{async get(e){const t=sessionStorage[e];return t?JSON.parse(t):null}async set(e,t){return sessionStorage[e]=JSON.stringify(t),t}async unset(e){return e in sessionStorage&&(delete sessionStorage[e],!0)}}},2612:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={expired:"Session expired! Please re-launch the app",noScopeForId:"Trying to get the ID of the selected %s. Please add 'launch' or 'launch/%s' to the requested scopes and try again.",noIfNoAuth:"You are trying to get %s but the app is not authorized yet.",noFreeContext:"Please don't use open fhir servers if you need to access launch context items like the %S."}},1227:(e,t,r)=>{t.formatArgs=function(t){if(t[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+t[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;const r="color: "+this.color;t.splice(1,0,r,"color: inherit");let n=0,a=0;t[0].replace(/%[a-zA-Z%]/g,(e=>{"%%"!==e&&(n++,"%c"===e&&(a=n))})),t.splice(a,0,r)},t.save=function(e){try{e?t.storage.setItem("debug",e):t.storage.removeItem("debug")}catch(e){}},t.load=function(){let e;try{e=t.storage.getItem("debug")}catch(e){}return!e&&"undefined"!=typeof process&&"env"in process&&(e=process.env.DEBUG),e},t.useColors=function(){return!("undefined"==typeof window||!window.process||"renderer"!==window.process.type&&!window.process.__nwjs)||("undefined"==typeof navigator||!navigator.userAgent||!navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))&&("undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/))},t.storage=function(){try{return localStorage}catch(e){}}(),t.destroy=(()=>{let e=!1;return()=>{e||(e=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],t.log=console.debug||console.log||(()=>{}),e.exports=r(2447)(t);const{formatters:n}=e.exports;n.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}},2447:(e,t,r)=>{e.exports=function(e){function t(e){let r,a,o,i=null;function s(...e){if(!s.enabled)return;const n=s,a=Number(new Date),o=a-(r||a);n.diff=o,n.prev=r,n.curr=a,r=a,e[0]=t.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let i=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,((r,a)=>{if("%%"===r)return"%";i++;const o=t.formatters[a];if("function"==typeof o){const t=e[i];r=o.call(n,t),e.splice(i,1),i--}return r})),t.formatArgs.call(n,e),(n.log||t.log).apply(n,e)}return s.namespace=e,s.useColors=t.useColors(),s.color=t.selectColor(e),s.extend=n,s.destroy=t.destroy,Object.defineProperty(s,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==i?i:(a!==t.namespaces&&(a=t.namespaces,o=t.enabled(e)),o),set:e=>{i=e}}),"function"==typeof t.init&&t.init(s),s}function n(e,r){const n=t(this.namespace+(void 0===r?":":r)+e);return n.log=this.log,n}function a(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return t.debug=t,t.default=t,t.coerce=function(e){return e instanceof Error?e.stack||e.message:e},t.disable=function(){const e=[...t.names.map(a),...t.skips.map(a).map((e=>"-"+e))].join(",");return t.enable(""),e},t.enable=function(e){let r;t.save(e),t.namespaces=e,t.names=[],t.skips=[];const n=("string"==typeof e?e:"").split(/[\s,]+/),a=n.length;for(r=0;r<a;r++)n[r]&&("-"===(e=n[r].replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.substr(1)+"$")):t.names.push(new RegExp("^"+e+"$")))},t.enabled=function(e){if("*"===e[e.length-1])return!0;let r,n;for(r=0,n=t.skips.length;r<n;r++)if(t.skips[r].test(e))return!1;for(r=0,n=t.names.length;r<n;r++)if(t.names[r].test(e))return!0;return!1},t.humanize=r(7824),t.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(e).forEach((r=>{t[r]=e[r]})),t.names=[],t.skips=[],t.formatters={},t.selectColor=function(e){let r=0;for(let t=0;t<e.length;t++)r=(r<<5)-r+e.charCodeAt(t),r|=0;return t.colors[Math.abs(r)%t.colors.length]},t.enable(t.load()),t}},7824:e=>{var t=1e3,r=60*t,n=60*r,a=24*n;function o(e,t,r,n){var a=t>=1.5*r;return Math.round(e/r)+" "+n+(a?"s":"")}e.exports=function(e,i){i=i||{};var s,c,d=typeof e;if("string"===d&&e.length>0)return function(e){if(!((e=String(e)).length>100)){var o=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(o){var i=parseFloat(o[1]);switch((o[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*i;case"weeks":case"week":case"w":return 6048e5*i;case"days":case"day":case"d":return i*a;case"hours":case"hour":case"hrs":case"hr":case"h":return i*n;case"minutes":case"minute":case"mins":case"min":case"m":return i*r;case"seconds":case"second":case"secs":case"sec":case"s":return i*t;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return i;default:return}}}}(e);if("number"===d&&isFinite(e))return i.long?(s=e,(c=Math.abs(s))>=a?o(s,c,a,"day"):c>=n?o(s,c,n,"hour"):c>=r?o(s,c,r,"minute"):c>=t?o(s,c,t,"second"):s+" ms"):function(e){var o=Math.abs(e);return o>=a?Math.round(e/a)+"d":o>=n?Math.round(e/n)+"h":o>=r?Math.round(e/r)+"m":o>=t?Math.round(e/t)+"s":e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}},7277:(e,t,r)=>{"use strict";r.r(t),r.d(t,{CompactEncrypt:()=>p.CompactEncrypt,CompactSign:()=>f.CompactSign,EmbeddedJWK:()=>E.EmbeddedJWK,EncryptJWT:()=>m.EncryptJWT,FlattenedEncrypt:()=>h.FlattenedEncrypt,FlattenedSign:()=>y.FlattenedSign,GeneralEncrypt:()=>i.GeneralEncrypt,GeneralSign:()=>w.GeneralSign,SignJWT:()=>g.SignJWT,UnsecuredJWT:()=>b.UnsecuredJWT,base64url:()=>H,calculateJwkThumbprint:()=>S.calculateJwkThumbprint,compactDecrypt:()=>n.compactDecrypt,compactVerify:()=>s.compactVerify,createLocalJWKSet:()=>v.createLocalJWKSet,createRemoteJWKSet:()=>A.createRemoteJWKSet,decodeJwt:()=>P.decodeJwt,decodeProtectedHeader:()=>J.decodeProtectedHeader,errors:()=>k,exportJWK:()=>C.exportJWK,exportPKCS8:()=>C.exportPKCS8,exportSPKI:()=>C.exportSPKI,flattenedDecrypt:()=>a.flattenedDecrypt,flattenedVerify:()=>c.flattenedVerify,generalDecrypt:()=>o.generalDecrypt,generalVerify:()=>d.generalVerify,generateKeyPair:()=>W.generateKeyPair,generateSecret:()=>K.generateSecret,importJWK:()=>_.importJWK,importPKCS8:()=>_.importPKCS8,importSPKI:()=>_.importSPKI,importX509:()=>_.importX509,jwtDecrypt:()=>l.jwtDecrypt,jwtVerify:()=>u.jwtVerify});var n=r(8920),a=r(8115),o=r(8982),i=r(5063),s=r(7309),c=r(8170),d=r(6257),u=r(5540),l=r(8112),p=r(2398),h=r(975),f=r(5326),y=r(9307),w=r(2310),g=r(3433),m=r(6125),S=r(814),E=r(2376),v=r(8464),A=r(9746),b=r(7770),C=r(2531),_=r(1503),J=r(3878),P=r(7879),k=r(8842),W=r(3619),K=r(2125),H=r(6001)},8920:(e,t,r)=>{"use strict";r.d(t,{compactDecrypt:()=>i});var n=r(8115),a=r(8842),o=r(1538);async function i(e,t,r){if(e instanceof Uint8Array&&(e=o.decoder.decode(e)),"string"!=typeof e)throw new a.JWEInvalid("Compact JWE must be a string or Uint8Array");const{0:i,1:s,2:c,3:d,4:u,length:l}=e.split(".");if(5!==l)throw new a.JWEInvalid("Invalid Compact JWE");const p=await(0,n.flattenedDecrypt)({ciphertext:d,iv:c||void 0,protected:i||void 0,tag:u||void 0,encrypted_key:s||void 0},t,r),h={plaintext:p.plaintext,protectedHeader:p.protectedHeader};return"function"==typeof t?{...h,key:p.key}:h}},2398:(e,t,r)=>{"use strict";r.d(t,{CompactEncrypt:()=>a});var n=r(975);class a{constructor(e){this._flattened=new n.FlattenedEncrypt(e)}setContentEncryptionKey(e){return this._flattened.setContentEncryptionKey(e),this}setInitializationVector(e){return this._flattened.setInitializationVector(e),this}setProtectedHeader(e){return this._flattened.setProtectedHeader(e),this}setKeyManagementParameters(e){return this._flattened.setKeyManagementParameters(e),this}async encrypt(e,t){const r=await this._flattened.encrypt(e,t);return[r.protected,r.encrypted_key,r.iv,r.ciphertext,r.tag].join(".")}}},8115:(e,t,r)=>{"use strict";r.d(t,{flattenedDecrypt:()=>f});var n=r(9166),a=r(5790),o=r(5515),i=r(8842),s=r(2085),c=r(2674),d=r(813),u=r(1538),l=r(1002),p=r(3406),h=r(5154);async function f(e,t,r){var f;if(!(0,c.default)(e))throw new i.JWEInvalid("Flattened JWE must be an object");if(void 0===e.protected&&void 0===e.header&&void 0===e.unprotected)throw new i.JWEInvalid("JOSE Header missing");if("string"!=typeof e.iv)throw new i.JWEInvalid("JWE Initialization Vector missing or incorrect type");if("string"!=typeof e.ciphertext)throw new i.JWEInvalid("JWE Ciphertext missing or incorrect type");if("string"!=typeof e.tag)throw new i.JWEInvalid("JWE Authentication Tag missing or incorrect type");if(void 0!==e.protected&&"string"!=typeof e.protected)throw new i.JWEInvalid("JWE Protected Header incorrect type");if(void 0!==e.encrypted_key&&"string"!=typeof e.encrypted_key)throw new i.JWEInvalid("JWE Encrypted Key incorrect type");if(void 0!==e.aad&&"string"!=typeof e.aad)throw new i.JWEInvalid("JWE AAD incorrect type");if(void 0!==e.header&&!(0,c.default)(e.header))throw new i.JWEInvalid("JWE Shared Unprotected Header incorrect type");if(void 0!==e.unprotected&&!(0,c.default)(e.unprotected))throw new i.JWEInvalid("JWE Per-Recipient Unprotected Header incorrect type");let y;if(e.protected){const t=(0,n.decode)(e.protected);try{y=JSON.parse(u.decoder.decode(t))}catch(e){throw new i.JWEInvalid("JWE Protected Header is invalid")}}if(!(0,s.default)(y,e.header,e.unprotected))throw new i.JWEInvalid("JWE Protected, JWE Unprotected Header, and JWE Per-Recipient Unprotected Header Parameter names must be disjoint");const w={...y,...e.header,...e.unprotected};if((0,p.default)(i.JWEInvalid,new Map,null==r?void 0:r.crit,y,w),void 0!==w.zip){if(!y||!y.zip)throw new i.JWEInvalid('JWE "zip" (Compression Algorithm) Header MUST be integrity protected');if("DEF"!==w.zip)throw new i.JOSENotSupported('Unsupported JWE "zip" (Compression Algorithm) Header Parameter value')}const{alg:g,enc:m}=w;if("string"!=typeof g||!g)throw new i.JWEInvalid("missing JWE Algorithm (alg) in JWE Header");if("string"!=typeof m||!m)throw new i.JWEInvalid("missing JWE Encryption Algorithm (enc) in JWE Header");const S=r&&(0,h.default)("keyManagementAlgorithms",r.keyManagementAlgorithms),E=r&&(0,h.default)("contentEncryptionAlgorithms",r.contentEncryptionAlgorithms);if(S&&!S.has(g))throw new i.JOSEAlgNotAllowed('"alg" (Algorithm) Header Parameter not allowed');if(E&&!E.has(m))throw new i.JOSEAlgNotAllowed('"enc" (Encryption Algorithm) Header Parameter not allowed');let v;void 0!==e.encrypted_key&&(v=(0,n.decode)(e.encrypted_key));let A,b=!1;"function"==typeof t&&(t=await t(y,e),b=!0);try{A=await(0,d.default)(g,t,v,w)}catch(e){if(e instanceof TypeError)throw e;A=(0,l.default)(m)}const C=(0,n.decode)(e.iv),_=(0,n.decode)(e.tag),J=u.encoder.encode(null!==(f=e.protected)&&void 0!==f?f:"");let P;P=void 0!==e.aad?(0,u.concat)(J,u.encoder.encode("."),u.encoder.encode(e.aad)):J;let k=await(0,a.default)(m,A,(0,n.decode)(e.ciphertext),C,_,P);"DEF"===w.zip&&(k=await((null==r?void 0:r.inflateRaw)||o.inflate)(k));const W={plaintext:k};return void 0!==e.protected&&(W.protectedHeader=y),void 0!==e.aad&&(W.additionalAuthenticatedData=(0,n.decode)(e.aad)),void 0!==e.unprotected&&(W.sharedUnprotectedHeader=e.unprotected),void 0!==e.header&&(W.unprotectedHeader=e.header),b?{...W,key:t}:W}},975:(e,t,r)=>{"use strict";r.d(t,{FlattenedEncrypt:()=>h,unprotected:()=>p});var n=r(9166),a=r(1088),o=r(5515),i=r(8948),s=r(8751),c=r(8842),d=r(2085),u=r(1538),l=r(3406);const p=Symbol();class h{constructor(e){if(!(e instanceof Uint8Array))throw new TypeError("plaintext must be an instance of Uint8Array");this._plaintext=e}setKeyManagementParameters(e){if(this._keyManagementParameters)throw new TypeError("setKeyManagementParameters can only be called once");return this._keyManagementParameters=e,this}setProtectedHeader(e){if(this._protectedHeader)throw new TypeError("setProtectedHeader can only be called once");return this._protectedHeader=e,this}setSharedUnprotectedHeader(e){if(this._sharedUnprotectedHeader)throw new TypeError("setSharedUnprotectedHeader can only be called once");return this._sharedUnprotectedHeader=e,this}setUnprotectedHeader(e){if(this._unprotectedHeader)throw new TypeError("setUnprotectedHeader can only be called once");return this._unprotectedHeader=e,this}setAdditionalAuthenticatedData(e){return this._aad=e,this}setContentEncryptionKey(e){if(this._cek)throw new TypeError("setContentEncryptionKey can only be called once");return this._cek=e,this}setInitializationVector(e){if(this._iv)throw new TypeError("setInitializationVector can only be called once");return this._iv=e,this}async encrypt(e,t){if(!this._protectedHeader&&!this._unprotectedHeader&&!this._sharedUnprotectedHeader)throw new c.JWEInvalid("either setProtectedHeader, setUnprotectedHeader, or sharedUnprotectedHeader must be called before #encrypt()");if(!(0,d.default)(this._protectedHeader,this._unprotectedHeader,this._sharedUnprotectedHeader))throw new c.JWEInvalid("JWE Protected, JWE Shared Unprotected and JWE Per-Recipient Header Parameter names must be disjoint");const r={...this._protectedHeader,...this._unprotectedHeader,...this._sharedUnprotectedHeader};if((0,l.default)(c.JWEInvalid,new Map,null==t?void 0:t.crit,this._protectedHeader,r),void 0!==r.zip){if(!this._protectedHeader||!this._protectedHeader.zip)throw new c.JWEInvalid('JWE "zip" (Compression Algorithm) Header MUST be integrity protected');if("DEF"!==r.zip)throw new c.JOSENotSupported('Unsupported JWE "zip" (Compression Algorithm) Header Parameter value')}const{alg:h,enc:f}=r;if("string"!=typeof h||!h)throw new c.JWEInvalid('JWE "alg" (Algorithm) Header Parameter missing or invalid');if("string"!=typeof f||!f)throw new c.JWEInvalid('JWE "enc" (Encryption Algorithm) Header Parameter missing or invalid');let y,w,g,m,S,E,v;if("dir"===h){if(this._cek)throw new TypeError("setContentEncryptionKey cannot be called when using Direct Encryption")}else if("ECDH-ES"===h&&this._cek)throw new TypeError("setContentEncryptionKey cannot be called when using Direct Key Agreement");{let r;({cek:w,encryptedKey:y,parameters:r}=await(0,s.default)(h,f,e,this._cek,this._keyManagementParameters)),r&&(t&&p in t?this._unprotectedHeader?this._unprotectedHeader={...this._unprotectedHeader,...r}:this.setUnprotectedHeader(r):this._protectedHeader?this._protectedHeader={...this._protectedHeader,...r}:this.setProtectedHeader(r))}if(this._iv||(this._iv=(0,i.default)(f)),m=this._protectedHeader?u.encoder.encode((0,n.encode)(JSON.stringify(this._protectedHeader))):u.encoder.encode(""),this._aad?(S=(0,n.encode)(this._aad),g=(0,u.concat)(m,u.encoder.encode("."),u.encoder.encode(S))):g=m,"DEF"===r.zip){const e=await((null==t?void 0:t.deflateRaw)||o.deflate)(this._plaintext);({ciphertext:E,tag:v}=await(0,a.default)(f,e,w,this._iv,g))}else({ciphertext:E,tag:v}=await(0,a.default)(f,this._plaintext,w,this._iv,g));const A={ciphertext:(0,n.encode)(E),iv:(0,n.encode)(this._iv),tag:(0,n.encode)(v)};return y&&(A.encrypted_key=(0,n.encode)(y)),S&&(A.aad=S),this._protectedHeader&&(A.protected=u.decoder.decode(m)),this._sharedUnprotectedHeader&&(A.unprotected=this._sharedUnprotectedHeader),this._unprotectedHeader&&(A.header=this._unprotectedHeader),A}}},8982:(e,t,r)=>{"use strict";r.d(t,{generalDecrypt:()=>i});var n=r(8115),a=r(8842),o=r(2674);async function i(e,t,r){if(!(0,o.default)(e))throw new a.JWEInvalid("General JWE must be an object");if(!Array.isArray(e.recipients)||!e.recipients.every(o.default))throw new a.JWEInvalid("JWE Recipients missing or incorrect type");if(!e.recipients.length)throw new a.JWEInvalid("JWE Recipients has no members");for(const a of e.recipients)try{return await(0,n.flattenedDecrypt)({aad:e.aad,ciphertext:e.ciphertext,encrypted_key:a.encrypted_key,header:a.header,iv:e.iv,protected:e.protected,tag:e.tag,unprotected:e.unprotected},t,r)}catch(e){}throw new a.JWEDecryptionFailed}},5063:(e,t,r)=>{"use strict";r.d(t,{GeneralEncrypt:()=>l});var n=r(975),a=r(8842),o=r(1002),i=r(2085),s=r(8751),c=r(9166),d=r(3406);class u{constructor(e,t,r){this.parent=e,this.key=t,this.options=r}setUnprotectedHeader(e){if(this.unprotectedHeader)throw new TypeError("setUnprotectedHeader can only be called once");return this.unprotectedHeader=e,this}addRecipient(...e){return this.parent.addRecipient(...e)}encrypt(...e){return this.parent.encrypt(...e)}done(){return this.parent}}class l{constructor(e){this._recipients=[],this._plaintext=e}addRecipient(e,t){const r=new u(this,e,{crit:null==t?void 0:t.crit});return this._recipients.push(r),r}setProtectedHeader(e){if(this._protectedHeader)throw new TypeError("setProtectedHeader can only be called once");return this._protectedHeader=e,this}setSharedUnprotectedHeader(e){if(this._unprotectedHeader)throw new TypeError("setSharedUnprotectedHeader can only be called once");return this._unprotectedHeader=e,this}setAdditionalAuthenticatedData(e){return this._aad=e,this}async encrypt(e){var t,r,u;if(!this._recipients.length)throw new a.JWEInvalid("at least one recipient must be added");if(e={deflateRaw:null==e?void 0:e.deflateRaw},1===this._recipients.length){const[t]=this._recipients,r=await new n.FlattenedEncrypt(this._plaintext).setAdditionalAuthenticatedData(this._aad).setProtectedHeader(this._protectedHeader).setSharedUnprotectedHeader(this._unprotectedHeader).setUnprotectedHeader(t.unprotectedHeader).encrypt(t.key,{...t.options,...e});let a={ciphertext:r.ciphertext,iv:r.iv,recipients:[{}],tag:r.tag};return r.aad&&(a.aad=r.aad),r.protected&&(a.protected=r.protected),r.unprotected&&(a.unprotected=r.unprotected),r.encrypted_key&&(a.recipients[0].encrypted_key=r.encrypted_key),r.header&&(a.recipients[0].header=r.header),a}let l;for(let e=0;e<this._recipients.length;e++){const t=this._recipients[e];if(!(0,i.default)(this._protectedHeader,this._unprotectedHeader,t.unprotectedHeader))throw new a.JWEInvalid("JWE Protected, JWE Shared Unprotected and JWE Per-Recipient Header Parameter names must be disjoint");const r={...this._protectedHeader,...this._unprotectedHeader,...t.unprotectedHeader},{alg:n}=r;if("string"!=typeof n||!n)throw new a.JWEInvalid('JWE "alg" (Algorithm) Header Parameter missing or invalid');if("dir"===n||"ECDH-ES"===n)throw new a.JWEInvalid('"dir" and "ECDH-ES" alg may only be used with a single recipient');if("string"!=typeof r.enc||!r.enc)throw new a.JWEInvalid('JWE "enc" (Encryption Algorithm) Header Parameter missing or invalid');if(l){if(l!==r.enc)throw new a.JWEInvalid('JWE "enc" (Encryption Algorithm) Header Parameter must be the same for all recipients')}else l=r.enc;if((0,d.default)(a.JWEInvalid,new Map,t.options.crit,this._protectedHeader,r),!(void 0===r.zip||this._protectedHeader&&this._protectedHeader.zip))throw new a.JWEInvalid('JWE "zip" (Compression Algorithm) Header MUST be integrity protected')}const p=(0,o.default)(l);let h={ciphertext:"",iv:"",recipients:[],tag:""};for(let a=0;a<this._recipients.length;a++){const o=this._recipients[a],i={};h.recipients.push(i);const d={...this._protectedHeader,...this._unprotectedHeader,...o.unprotectedHeader}.alg.startsWith("PBES2")?2048+a:void 0;if(0===a){const t=await new n.FlattenedEncrypt(this._plaintext).setAdditionalAuthenticatedData(this._aad).setContentEncryptionKey(p).setProtectedHeader(this._protectedHeader).setSharedUnprotectedHeader(this._unprotectedHeader).setUnprotectedHeader(o.unprotectedHeader).setKeyManagementParameters({p2c:d}).encrypt(o.key,{...o.options,...e,[n.unprotected]:!0});h.ciphertext=t.ciphertext,h.iv=t.iv,h.tag=t.tag,t.aad&&(h.aad=t.aad),t.protected&&(h.protected=t.protected),t.unprotected&&(h.unprotected=t.unprotected),i.encrypted_key=t.encrypted_key,t.header&&(i.header=t.header);continue}const{encryptedKey:f,parameters:y}=await(0,s.default)((null===(t=o.unprotectedHeader)||void 0===t?void 0:t.alg)||(null===(r=this._protectedHeader)||void 0===r?void 0:r.alg)||(null===(u=this._unprotectedHeader)||void 0===u?void 0:u.alg),l,o.key,p,{p2c:d});i.encrypted_key=(0,c.encode)(f),(o.unprotectedHeader||y)&&(i.header={...o.unprotectedHeader,...y})}return h}}},2376:(e,t,r)=>{"use strict";r.d(t,{EmbeddedJWK:()=>i});var n=r(1503),a=r(2674),o=r(8842);async function i(e,t){const r={...e,...t.header};if(!(0,a.default)(r.jwk))throw new o.JWSInvalid('"jwk" (JSON Web Key) Header Parameter must be a JSON object');const i=await(0,n.importJWK)({...r.jwk,ext:!0},r.alg,!0);if(i instanceof Uint8Array||"public"!==i.type)throw new o.JWSInvalid('"jwk" (JSON Web Key) Header Parameter must be a public key');return i}},814:(e,t,r)=>{"use strict";r.d(t,{calculateJwkThumbprint:()=>d});var n=r(183),a=r(9166),o=r(8842),i=r(1538),s=r(2674);const c=(e,t)=>{if("string"!=typeof e||!e)throw new o.JWKInvalid(`${t} missing or invalid`)};async function d(e,t="sha256"){if(!(0,s.default)(e))throw new TypeError("JWK must be an object");if("sha256"!==t&&"sha384"!==t&&"sha512"!==t)throw new TypeError('digestAlgorithm must one of "sha256", "sha384", or "sha512"');let r;switch(e.kty){case"EC":c(e.crv,'"crv" (Curve) Parameter'),c(e.x,'"x" (X Coordinate) Parameter'),c(e.y,'"y" (Y Coordinate) Parameter'),r={crv:e.crv,kty:e.kty,x:e.x,y:e.y};break;case"OKP":c(e.crv,'"crv" (Subtype of Key Pair) Parameter'),c(e.x,'"x" (Public Key) Parameter'),r={crv:e.crv,kty:e.kty,x:e.x};break;case"RSA":c(e.e,'"e" (Exponent) Parameter'),c(e.n,'"n" (Modulus) Parameter'),r={e:e.e,kty:e.kty,n:e.n};break;case"oct":c(e.k,'"k" (Key Value) Parameter'),r={k:e.k,kty:e.kty};break;default:throw new o.JOSENotSupported('"kty" (Key Type) Parameter missing or unsupported')}const d=i.encoder.encode(JSON.stringify(r));return(0,a.encode)(await(0,n.default)(t,d))}},8464:(e,t,r)=>{"use strict";r.d(t,{LocalJWKSet:()=>c,createLocalJWKSet:()=>d,isJWKSLike:()=>i});var n=r(1503),a=r(8842),o=r(2674);function i(e){return e&&"object"==typeof e&&Array.isArray(e.keys)&&e.keys.every(s)}function s(e){return(0,o.default)(e)}class c{constructor(e){if(this._cached=new WeakMap,!i(e))throw new a.JWKSInvalid("JSON Web Key Set malformed");var t;this._jwks=(t=e,"function"==typeof structuredClone?structuredClone(t):JSON.parse(JSON.stringify(t)))}async getKey(e,t){const{alg:r,kid:o}={...e,...t.header},i=this._jwks.keys.filter((e=>{let t=e.kty===function(e){switch("string"==typeof e&&e.slice(0,2)){case"RS":case"PS":return"RSA";case"ES":return"EC";case"Ed":return"OKP";default:throw new a.JOSENotSupported('Unsupported "alg" value for a JSON Web Key Set')}}(r);if(t&&"string"==typeof o&&(t=o===e.kid),t&&"string"==typeof e.alg&&(t=r===e.alg),t&&"string"==typeof e.use&&(t="sig"===e.use),t&&Array.isArray(e.key_ops)&&(t=e.key_ops.includes("verify")),t&&"EdDSA"===r&&(t="Ed25519"===e.crv||"Ed448"===e.crv),t)switch(r){case"ES256":t="P-256"===e.crv;break;case"ES256K":t="secp256k1"===e.crv;break;case"ES384":t="P-384"===e.crv;break;case"ES512":t="P-521"===e.crv}return t})),{0:s,length:c}=i;if(0===c)throw new a.JWKSNoMatchingKey;if(1!==c)throw new a.JWKSMultipleMatchingKeys;const d=this._cached.get(s)||this._cached.set(s,{}).get(s);if(void 0===d[r]){const e=await(0,n.importJWK)({...s,ext:!0},r);if(e instanceof Uint8Array||"public"!==e.type)throw new a.JWKSInvalid("JSON Web Key Set members must be public keys");d[r]=e}return d[r]}}function d(e){return c.prototype.getKey.bind(new c(e))}},9746:(e,t,r)=>{"use strict";r.d(t,{createRemoteJWKSet:()=>c});var n=r(6931),a=r(286),o=r(8842),i=r(8464);class s extends i.LocalJWKSet{constructor(e,t){if(super({keys:[]}),this._jwks=void 0,!(e instanceof URL))throw new TypeError("url must be an instance of URL");this._url=new URL(e.href),this._options={agent:null==t?void 0:t.agent},this._timeoutDuration="number"==typeof(null==t?void 0:t.timeoutDuration)?null==t?void 0:t.timeoutDuration:5e3,this._cooldownDuration="number"==typeof(null==t?void 0:t.cooldownDuration)?null==t?void 0:t.cooldownDuration:3e4}coolingDown(){return!!this._cooldownStarted&&Date.now()<this._cooldownStarted+this._cooldownDuration}async getKey(e,t){this._jwks||await this.reload();try{return await super.getKey(e,t)}catch(r){if(r instanceof o.JWKSNoMatchingKey&&!1===this.coolingDown())return await this.reload(),super.getKey(e,t);throw r}}async reload(){if(this._pendingFetch&&(0,a.isCloudflareWorkers)())return new Promise((e=>{const t=()=>{void 0===this._pendingFetch?e():setTimeout(t,5)};t()}));this._pendingFetch||(this._pendingFetch=(0,n.default)(this._url,this._timeoutDuration,this._options).then((e=>{if(!(0,i.isJWKSLike)(e))throw new o.JWKSInvalid("JSON Web Key Set malformed");this._jwks={keys:e.keys},this._cooldownStarted=Date.now(),this._pendingFetch=void 0})).catch((e=>{throw this._pendingFetch=void 0,e}))),await this._pendingFetch}}function c(e,t){return s.prototype.getKey.bind(new s(e,t))}},5326:(e,t,r)=>{"use strict";r.d(t,{CompactSign:()=>a});var n=r(9307);class a{constructor(e){this._flattened=new n.FlattenedSign(e)}setProtectedHeader(e){return this._flattened.setProtectedHeader(e),this}async sign(e,t){const r=await this._flattened.sign(e,t);if(void 0===r.payload)throw new TypeError("use the flattened module for creating JWS with b64: false");return`${r.protected}.${r.payload}.${r.signature}`}}},7309:(e,t,r)=>{"use strict";r.d(t,{compactVerify:()=>i});var n=r(8170),a=r(8842),o=r(1538);async function i(e,t,r){if(e instanceof Uint8Array&&(e=o.decoder.decode(e)),"string"!=typeof e)throw new a.JWSInvalid("Compact JWS must be a string or Uint8Array");const{0:i,1:s,2:c,length:d}=e.split(".");if(3!==d)throw new a.JWSInvalid("Invalid Compact JWS");const u=await(0,n.flattenedVerify)({payload:s,protected:i,signature:c},t,r),l={payload:u.payload,protectedHeader:u.protectedHeader};return"function"==typeof t?{...l,key:u.key}:l}},9307:(e,t,r)=>{"use strict";r.d(t,{FlattenedSign:()=>u});var n=r(9166),a=r(3736),o=r(2085),i=r(8842),s=r(1538),c=r(2200),d=r(3406);class u{constructor(e){if(!(e instanceof Uint8Array))throw new TypeError("payload must be an instance of Uint8Array");this._payload=e}setProtectedHeader(e){if(this._protectedHeader)throw new TypeError("setProtectedHeader can only be called once");return this._protectedHeader=e,this}setUnprotectedHeader(e){if(this._unprotectedHeader)throw new TypeError("setUnprotectedHeader can only be called once");return this._unprotectedHeader=e,this}async sign(e,t){if(!this._protectedHeader&&!this._unprotectedHeader)throw new i.JWSInvalid("either setProtectedHeader or setUnprotectedHeader must be called before #sign()");if(!(0,o.default)(this._protectedHeader,this._unprotectedHeader))throw new i.JWSInvalid("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");const r={...this._protectedHeader,...this._unprotectedHeader};let u=!0;if((0,d.default)(i.JWSInvalid,new Map([["b64",!0]]),null==t?void 0:t.crit,this._protectedHeader,r).has("b64")&&(u=this._protectedHeader.b64,"boolean"!=typeof u))throw new i.JWSInvalid('The "b64" (base64url-encode payload) Header Parameter must be a boolean');const{alg:l}=r;if("string"!=typeof l||!l)throw new i.JWSInvalid('JWS "alg" (Algorithm) Header Parameter missing or invalid');(0,c.default)(l,e,"sign");let p,h=this._payload;u&&(h=s.encoder.encode((0,n.encode)(h))),p=this._protectedHeader?s.encoder.encode((0,n.encode)(JSON.stringify(this._protectedHeader))):s.encoder.encode("");const f=(0,s.concat)(p,s.encoder.encode("."),h),y=await(0,a.default)(l,e,f),w={signature:(0,n.encode)(y),payload:""};return u&&(w.payload=s.decoder.decode(h)),this._unprotectedHeader&&(w.header=this._unprotectedHeader),this._protectedHeader&&(w.protected=s.decoder.decode(p)),w}}},8170:(e,t,r)=>{"use strict";r.d(t,{flattenedVerify:()=>p});var n=r(9166),a=r(6239),o=r(8842),i=r(1538),s=r(2085),c=r(2674),d=r(2200),u=r(3406),l=r(5154);async function p(e,t,r){var p;if(!(0,c.default)(e))throw new o.JWSInvalid("Flattened JWS must be an object");if(void 0===e.protected&&void 0===e.header)throw new o.JWSInvalid('Flattened JWS must have either of the "protected" or "header" members');if(void 0!==e.protected&&"string"!=typeof e.protected)throw new o.JWSInvalid("JWS Protected Header incorrect type");if(void 0===e.payload)throw new o.JWSInvalid("JWS Payload missing");if("string"!=typeof e.signature)throw new o.JWSInvalid("JWS Signature missing or incorrect type");if(void 0!==e.header&&!(0,c.default)(e.header))throw new o.JWSInvalid("JWS Unprotected Header incorrect type");let h={};if(e.protected){const t=(0,n.decode)(e.protected);try{h=JSON.parse(i.decoder.decode(t))}catch(e){throw new o.JWSInvalid("JWS Protected Header is invalid")}}if(!(0,s.default)(h,e.header))throw new o.JWSInvalid("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");const f={...h,...e.header};let y=!0;if((0,u.default)(o.JWSInvalid,new Map([["b64",!0]]),null==r?void 0:r.crit,h,f).has("b64")&&(y=h.b64,"boolean"!=typeof y))throw new o.JWSInvalid('The "b64" (base64url-encode payload) Header Parameter must be a boolean');const{alg:w}=f;if("string"!=typeof w||!w)throw new o.JWSInvalid('JWS "alg" (Algorithm) Header Parameter missing or invalid');const g=r&&(0,l.default)("algorithms",r.algorithms);if(g&&!g.has(w))throw new o.JOSEAlgNotAllowed('"alg" (Algorithm) Header Parameter not allowed');if(y){if("string"!=typeof e.payload)throw new o.JWSInvalid("JWS Payload must be a string")}else if("string"!=typeof e.payload&&!(e.payload instanceof Uint8Array))throw new o.JWSInvalid("JWS Payload must be a string or an Uint8Array instance");let m=!1;"function"==typeof t&&(t=await t(h,e),m=!0),(0,d.default)(w,t,"verify");const S=(0,i.concat)(i.encoder.encode(null!==(p=e.protected)&&void 0!==p?p:""),i.encoder.encode("."),"string"==typeof e.payload?i.encoder.encode(e.payload):e.payload),E=(0,n.decode)(e.signature);if(!await(0,a.default)(w,t,E,S))throw new o.JWSSignatureVerificationFailed;let v;v=y?(0,n.decode)(e.payload):"string"==typeof e.payload?i.encoder.encode(e.payload):e.payload;const A={payload:v};return void 0!==e.protected&&(A.protectedHeader=h),void 0!==e.header&&(A.unprotectedHeader=e.header),m?{...A,key:t}:A}},2310:(e,t,r)=>{"use strict";r.d(t,{GeneralSign:()=>i});var n=r(9307),a=r(8842);class o{constructor(e,t,r){this.parent=e,this.key=t,this.options=r}setProtectedHeader(e){if(this.protectedHeader)throw new TypeError("setProtectedHeader can only be called once");return this.protectedHeader=e,this}setUnprotectedHeader(e){if(this.unprotectedHeader)throw new TypeError("setUnprotectedHeader can only be called once");return this.unprotectedHeader=e,this}addSignature(...e){return this.parent.addSignature(...e)}sign(...e){return this.parent.sign(...e)}done(){return this.parent}}class i{constructor(e){this._signatures=[],this._payload=e}addSignature(e,t){const r=new o(this,e,t);return this._signatures.push(r),r}async sign(){if(!this._signatures.length)throw new a.JWSInvalid("at least one signature must be added");const e={signatures:[],payload:""};for(let t=0;t<this._signatures.length;t++){const r=this._signatures[t],o=new n.FlattenedSign(this._payload);o.setProtectedHeader(r.protectedHeader),o.setUnprotectedHeader(r.unprotectedHeader);const{payload:i,...s}=await o.sign(r.key,r.options);if(0===t)e.payload=i;else if(e.payload!==i)throw new a.JWSInvalid("inconsistent use of JWS Unencoded Payload Option (RFC7797)");e.signatures.push(s)}return e}}},6257:(e,t,r)=>{"use strict";r.d(t,{generalVerify:()=>i});var n=r(8170),a=r(8842),o=r(2674);async function i(e,t,r){if(!(0,o.default)(e))throw new a.JWSInvalid("General JWS must be an object");if(!Array.isArray(e.signatures)||!e.signatures.every(o.default))throw new a.JWSInvalid("JWS Signatures missing or incorrect type");for(const a of e.signatures)try{return await(0,n.flattenedVerify)({header:a.header,payload:e.payload,protected:a.protected,signature:a.signature},t,r)}catch(e){}throw new a.JWSSignatureVerificationFailed}},8112:(e,t,r)=>{"use strict";r.d(t,{jwtDecrypt:()=>i});var n=r(8920),a=r(3358),o=r(8842);async function i(e,t,r){const i=await(0,n.compactDecrypt)(e,t,r),s=(0,a.default)(i.protectedHeader,i.plaintext,r),{protectedHeader:c}=i;if(void 0!==c.iss&&c.iss!==s.iss)throw new o.JWTClaimValidationFailed('replicated "iss" claim header parameter mismatch',"iss","mismatch");if(void 0!==c.sub&&c.sub!==s.sub)throw new o.JWTClaimValidationFailed('replicated "sub" claim header parameter mismatch',"sub","mismatch");if(void 0!==c.aud&&JSON.stringify(c.aud)!==JSON.stringify(s.aud))throw new o.JWTClaimValidationFailed('replicated "aud" claim header parameter mismatch',"aud","mismatch");const d={payload:s,protectedHeader:c};return"function"==typeof t?{...d,key:i.key}:d}},6125:(e,t,r)=>{"use strict";r.d(t,{EncryptJWT:()=>i});var n=r(2398),a=r(1538),o=r(2579);class i extends o.ProduceJWT{setProtectedHeader(e){if(this._protectedHeader)throw new TypeError("setProtectedHeader can only be called once");return this._protectedHeader=e,this}setKeyManagementParameters(e){if(this._keyManagementParameters)throw new TypeError("setKeyManagementParameters can only be called once");return this._keyManagementParameters=e,this}setContentEncryptionKey(e){if(this._cek)throw new TypeError("setContentEncryptionKey can only be called once");return this._cek=e,this}setInitializationVector(e){if(this._iv)throw new TypeError("setInitializationVector can only be called once");return this._iv=e,this}replicateIssuerAsHeader(){return this._replicateIssuerAsHeader=!0,this}replicateSubjectAsHeader(){return this._replicateSubjectAsHeader=!0,this}replicateAudienceAsHeader(){return this._replicateAudienceAsHeader=!0,this}async encrypt(e,t){const r=new n.CompactEncrypt(a.encoder.encode(JSON.stringify(this._payload)));return this._replicateIssuerAsHeader&&(this._protectedHeader={...this._protectedHeader,iss:this._payload.iss}),this._replicateSubjectAsHeader&&(this._protectedHeader={...this._protectedHeader,sub:this._payload.sub}),this._replicateAudienceAsHeader&&(this._protectedHeader={...this._protectedHeader,aud:this._payload.aud}),r.setProtectedHeader(this._protectedHeader),this._iv&&r.setInitializationVector(this._iv),this._cek&&r.setContentEncryptionKey(this._cek),this._keyManagementParameters&&r.setKeyManagementParameters(this._keyManagementParameters),r.encrypt(e,t)}}},2579:(e,t,r)=>{"use strict";r.d(t,{ProduceJWT:()=>i});var n=r(4925),a=r(2674),o=r(7272);class i{constructor(e){if(!(0,a.default)(e))throw new TypeError("JWT Claims Set MUST be an object");this._payload=e}setIssuer(e){return this._payload={...this._payload,iss:e},this}setSubject(e){return this._payload={...this._payload,sub:e},this}setAudience(e){return this._payload={...this._payload,aud:e},this}setJti(e){return this._payload={...this._payload,jti:e},this}setNotBefore(e){return this._payload="number"==typeof e?{...this._payload,nbf:e}:{...this._payload,nbf:(0,n.default)(new Date)+(0,o.default)(e)},this}setExpirationTime(e){return this._payload="number"==typeof e?{...this._payload,exp:e}:{...this._payload,exp:(0,n.default)(new Date)+(0,o.default)(e)},this}setIssuedAt(e){return this._payload=void 0===e?{...this._payload,iat:(0,n.default)(new Date)}:{...this._payload,iat:e},this}}},3433:(e,t,r)=>{"use strict";r.d(t,{SignJWT:()=>s});var n=r(5326),a=r(8842),o=r(1538),i=r(2579);class s extends i.ProduceJWT{setProtectedHeader(e){return this._protectedHeader=e,this}async sign(e,t){var r;const i=new n.CompactSign(o.encoder.encode(JSON.stringify(this._payload)));if(i.setProtectedHeader(this._protectedHeader),Array.isArray(null===(r=this._protectedHeader)||void 0===r?void 0:r.crit)&&this._protectedHeader.crit.includes("b64")&&!1===this._protectedHeader.b64)throw new a.JWTInvalid("JWTs MUST NOT use unencoded payload");return i.sign(e,t)}}},7770:(e,t,r)=>{"use strict";r.d(t,{UnsecuredJWT:()=>c});var n=r(9166),a=r(1538),o=r(8842),i=r(3358),s=r(2579);class c extends s.ProduceJWT{encode(){return`${n.encode(JSON.stringify({alg:"none"}))}.${n.encode(JSON.stringify(this._payload))}.`}static decode(e,t){if("string"!=typeof e)throw new o.JWTInvalid("Unsecured JWT must be a string");const{0:r,1:s,2:c,length:d}=e.split(".");if(3!==d||""!==c)throw new o.JWTInvalid("Invalid Unsecured JWT");let u;try{if(u=JSON.parse(a.decoder.decode(n.decode(r))),"none"!==u.alg)throw new Error}catch(e){throw new o.JWTInvalid("Invalid Unsecured JWT")}return{payload:(0,i.default)(u,n.decode(s),t),header:u}}}},5540:(e,t,r)=>{"use strict";r.d(t,{jwtVerify:()=>i});var n=r(7309),a=r(3358),o=r(8842);async function i(e,t,r){var i;const s=await(0,n.compactVerify)(e,t,r);if((null===(i=s.protectedHeader.crit)||void 0===i?void 0:i.includes("b64"))&&!1===s.protectedHeader.b64)throw new o.JWTInvalid("JWTs MUST NOT use unencoded payload");const c={payload:(0,a.default)(s.protectedHeader,s.payload,r),protectedHeader:s.protectedHeader};return"function"==typeof t?{...c,key:s.key}:c}},2531:(e,t,r)=>{"use strict";r.d(t,{exportJWK:()=>s,exportPKCS8:()=>i,exportSPKI:()=>o});var n=r(6134),a=r(1858);async function o(e){return(0,n.toSPKI)(e)}async function i(e){return(0,n.toPKCS8)(e)}async function s(e){return(0,a.default)(e)}},3619:(e,t,r)=>{"use strict";r.d(t,{generateKeyPair:()=>a});var n=r(7957);async function a(e,t){return(0,n.generateKeyPair)(e,t)}},2125:(e,t,r)=>{"use strict";r.d(t,{generateSecret:()=>a});var n=r(7957);async function a(e,t){return(0,n.generateSecret)(e,t)}},1503:(e,t,r)=>{"use strict";r.d(t,{importJWK:()=>f,importPKCS8:()=>h,importSPKI:()=>l,importX509:()=>p});var n=r(9166),a=r(6134),o=r(6604),i=r(8842),s=r(8812),c=r(2674);function d(e){let t=[],r=0;for(;r<e.length;){let n=u(e.subarray(r));t.push(n),r+=n.byteLength}return t}function u(e){let t=0,r=31&e[0];if(t++,31===r){for(r=0;e[t]>=128;)r=128*r+e[t]-128,t++;r=128*r+e[t]-128,t++}let n=0;if(e[t]<128)n=e[t],t++;else{let r=127&e[t];t++,n=0;for(let a=0;a<r;a++)n=256*n+e[t],t++}if(128===n){for(n=0;0!==e[t+n]||0!==e[t+n+1];)n++;const r=t+n+2;return{byteLength:r,contents:e.subarray(t,t+n),raw:e.subarray(0,r)}}const a=t+n;return{byteLength:a,contents:e.subarray(t,a),raw:e.subarray(0,a)}}async function l(e,t,r){if("string"!=typeof e||0!==e.indexOf("-----BEGIN PUBLIC KEY-----"))throw new TypeError('"spki" must be SPKI formatted string');return(0,a.fromSPKI)(e,t,r)}async function p(e,t,r){if("string"!=typeof e||0!==e.indexOf("-----BEGIN CERTIFICATE-----"))throw new TypeError('"x509" must be X.509 formatted string');const o=function(e){const t=e.replace(/(?:-----(?:BEGIN|END) CERTIFICATE-----|\s)/g,""),r=(0,n.decodeBase64)(t);return(0,s.default)(function(e){const t=d(d(u(e).contents)[0].contents);return(0,n.encodeBase64)(t[160===t[0].raw[0]?6:5].raw)}(r),"PUBLIC KEY")}(e);return(0,a.fromSPKI)(o,t,r)}async function h(e,t,r){if("string"!=typeof e||0!==e.indexOf("-----BEGIN PRIVATE KEY-----"))throw new TypeError('"pkcs8" must be PCKS8 formatted string');return(0,a.fromPKCS8)(e,t,r)}async function f(e,t,r){if(!(0,c.default)(e))throw new TypeError("JWK must be an object");if(t||(t=e.alg),"string"!=typeof t||!t)throw new TypeError('"alg" argument is required when "jwk.alg" is not present');switch(e.kty){case"oct":if("string"!=typeof e.k||!e.k)throw new TypeError('missing "k" (Key Value) Parameter value');return null!=r||(r=!0!==e.ext),r?(0,o.default)({...e,alg:t,ext:!1}):(0,n.decode)(e.k);case"RSA":if(void 0!==e.oth)throw new i.JOSENotSupported('RSA JWK "oth" (Other Primes Info) Parameter value is not supported');case"EC":case"OKP":return(0,o.default)({...e,alg:t});default:throw new i.JOSENotSupported('Unsupported "kty" (Key Type) Parameter value')}}},1897:(e,t,r)=>{"use strict";r.d(t,{unwrap:()=>c,wrap:()=>s});var n=r(1088),a=r(5790),o=r(8948),i=r(9166);async function s(e,t,r,a){const s=e.slice(0,7);a||(a=(0,o.default)(s));const{ciphertext:c,tag:d}=await(0,n.default)(s,r,t,a,new Uint8Array(0));return{encryptedKey:c,iv:(0,i.encode)(a),tag:(0,i.encode)(d)}}async function c(e,t,r,n,o){const i=e.slice(0,7);return(0,a.default)(i,t,r,n,o,new Uint8Array(0))}},1538:(e,t,r)=>{"use strict";r.d(t,{concat:()=>s,concatKdf:()=>h,decoder:()=>o,encoder:()=>a,lengthAndInput:()=>p,p2s:()=>c,uint32be:()=>l,uint64be:()=>u});var n=r(183);const a=new TextEncoder,o=new TextDecoder,i=2**32;function s(...e){const t=e.reduce(((e,{length:t})=>e+t),0),r=new Uint8Array(t);let n=0;return e.forEach((e=>{r.set(e,n),n+=e.length})),r}function c(e,t){return s(a.encode(e),new Uint8Array([0]),t)}function d(e,t,r){if(t<0||t>=i)throw new RangeError(`value must be >= 0 and <= 4294967295. Received ${t}`);e.set([t>>>24,t>>>16,t>>>8,255&t],r)}function u(e){const t=Math.floor(e/i),r=e%i,n=new Uint8Array(8);return d(n,t,0),d(n,r,4),n}function l(e){const t=new Uint8Array(4);return d(t,e),t}function p(e){return s(l(e.length),e)}async function h(e,t,r){const a=Math.ceil((t>>3)/32);let o;for(let t=1;t<=a;t++){const a=new Uint8Array(4+e.length+r.length);a.set(l(t)),a.set(e,4),a.set(r,4+e.length),o=o?s(o,await(0,n.default)("sha256",a)):await(0,n.default)("sha256",a)}return o=o.slice(0,t>>3),o}},1002:(e,t,r)=>{"use strict";r.d(t,{bitLength:()=>o,default:()=>i});var n=r(8842),a=r(5579);function o(e){switch(e){case"A128GCM":return 128;case"A192GCM":return 192;case"A256GCM":case"A128CBC-HS256":return 256;case"A192CBC-HS384":return 384;case"A256CBC-HS512":return 512;default:throw new n.JOSENotSupported(`Unsupported JWE Algorithm: ${e}`)}}const i=e=>(0,a.default)(new Uint8Array(o(e)>>3))},373:(e,t,r)=>{"use strict";r.d(t,{default:()=>o});var n=r(8842),a=r(8948);const o=(e,t)=>{if(t.length<<3!==(0,a.bitLength)(e))throw new n.JWEInvalid("Invalid Initialization Vector length")}},2200:(e,t,r)=>{"use strict";r.d(t,{default:()=>o});var n=r(3114),a=r(7732);const o=(e,t,r)=>{e.startsWith("HS")||"dir"===e||e.startsWith("PBES2")||/^A\d{3}(?:GCM)?KW$/.test(e)?(e=>{if(!(e instanceof Uint8Array)){if(!(0,a.default)(e))throw new TypeError((0,n.default)(e,...a.types,"Uint8Array"));if("secret"!==e.type)throw new TypeError(`${a.types.join(" or ")} instances for symmetric algorithms must be of type "secret"`)}})(t):((e,t)=>{if(!(0,a.default)(e))throw new TypeError((0,n.default)(e,...a.types));if("secret"===e.type)throw new TypeError(`${a.types.join(" or ")} instances for asymmetric algorithms must not be of type "secret"`);if("sign"===t&&"public"===e.type)throw new TypeError(`${a.types.join(" or ")} instances for asymmetric algorithm signing must be of type "private"`);if("decrypt"===t&&"public"===e.type)throw new TypeError(`${a.types.join(" or ")} instances for asymmetric algorithm decryption must be of type "private"`);if(e.algorithm&&"verify"===t&&"private"===e.type)throw new TypeError(`${a.types.join(" or ")} instances for asymmetric algorithm verifying must be of type "public"`);if(e.algorithm&&"encrypt"===t&&"private"===e.type)throw new TypeError(`${a.types.join(" or ")} instances for asymmetric algorithm encryption must be of type "public"`)})(t,r)}},4044:(e,t,r)=>{"use strict";r.d(t,{default:()=>a});var n=r(8842);function a(e){if(!(e instanceof Uint8Array)||e.length<8)throw new n.JWEInvalid("PBES2 Salt Input must be 8 or more octets")}},9492:(e,t,r)=>{"use strict";r.d(t,{checkEncCryptoKey:()=>d,checkSigCryptoKey:()=>c});var n=r(286);function a(e,t="algorithm.name"){return new TypeError(`CryptoKey does not support this operation, its ${t} must be ${e}`)}function o(e,t){return e.name===t}function i(e){return parseInt(e.name.slice(4),10)}function s(e,t){if(t.length&&!t.some((t=>e.usages.includes(t)))){let e="CryptoKey does not support this operation, its usages must include ";if(t.length>2){const r=t.pop();e+=`one of ${t.join(", ")}, or ${r}.`}else 2===t.length?e+=`one of ${t[0]} or ${t[1]}.`:e+=`${t[0]}.`;throw new TypeError(e)}}function c(e,t,...r){switch(t){case"HS256":case"HS384":case"HS512":{if(!o(e.algorithm,"HMAC"))throw a("HMAC");const r=parseInt(t.slice(2),10);if(i(e.algorithm.hash)!==r)throw a(`SHA-${r}`,"algorithm.hash");break}case"RS256":case"RS384":case"RS512":{if(!o(e.algorithm,"RSASSA-PKCS1-v1_5"))throw a("RSASSA-PKCS1-v1_5");const r=parseInt(t.slice(2),10);if(i(e.algorithm.hash)!==r)throw a(`SHA-${r}`,"algorithm.hash");break}case"PS256":case"PS384":case"PS512":{if(!o(e.algorithm,"RSA-PSS"))throw a("RSA-PSS");const r=parseInt(t.slice(2),10);if(i(e.algorithm.hash)!==r)throw a(`SHA-${r}`,"algorithm.hash");break}case(0,n.isNodeJs)()&&"EdDSA":if("NODE-ED25519"!==e.algorithm.name&&"NODE-ED448"!==e.algorithm.name)throw a("NODE-ED25519 or NODE-ED448");break;case(0,n.isCloudflareWorkers)()&&"EdDSA":if(!o(e.algorithm,"NODE-ED25519"))throw a("NODE-ED25519");break;case"ES256":case"ES384":case"ES512":{if(!o(e.algorithm,"ECDSA"))throw a("ECDSA");const r=function(e){switch(e){case"ES256":return"P-256";case"ES384":return"P-384";case"ES512":return"P-521";default:throw new Error("unreachable")}}(t);if(e.algorithm.namedCurve!==r)throw a(r,"algorithm.namedCurve");break}default:throw new TypeError("CryptoKey does not support this operation")}s(e,r)}function d(e,t,...r){switch(t){case"A128GCM":case"A192GCM":case"A256GCM":{if(!o(e.algorithm,"AES-GCM"))throw a("AES-GCM");const r=parseInt(t.slice(1,4),10);if(e.algorithm.length!==r)throw a(r,"algorithm.length");break}case"A128KW":case"A192KW":case"A256KW":{if(!o(e.algorithm,"AES-KW"))throw a("AES-KW");const r=parseInt(t.slice(1,4),10);if(e.algorithm.length!==r)throw a(r,"algorithm.length");break}case"ECDH":if(!o(e.algorithm,"ECDH"))throw a("ECDH");break;case"PBES2-HS256+A128KW":case"PBES2-HS384+A192KW":case"PBES2-HS512+A256KW":if(!o(e.algorithm,"PBKDF2"))throw a("PBKDF2");break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":{if(!o(e.algorithm,"RSA-OAEP"))throw a("RSA-OAEP");const r=parseInt(t.slice(9),10)||1;if(i(e.algorithm.hash)!==r)throw a(`SHA-${r}`,"algorithm.hash");break}default:throw new TypeError("CryptoKey does not support this operation")}s(e,r)}},813:(e,t,r)=>{"use strict";r.d(t,{default:()=>f});var n=r(4714),a=r(5193),o=r(4230),i=r(2453),s=r(9166),c=r(8842),d=r(1002),u=r(1503),l=r(2200),p=r(2674),h=r(1897);const f=async function(e,t,r,f){switch((0,l.default)(e,t,"decrypt"),e){case"dir":if(void 0!==r)throw new c.JWEInvalid("Encountered unexpected JWE Encrypted Key");return t;case"ECDH-ES":if(void 0!==r)throw new c.JWEInvalid("Encountered unexpected JWE Encrypted Key");case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":{if(!(0,p.default)(f.epk))throw new c.JWEInvalid('JOSE Header "epk" (Ephemeral Public Key) missing or invalid');if(!a.ecdhAllowed(t))throw new c.JOSENotSupported("ECDH with the provided key is not allowed or not supported by your javascript runtime");const o=await(0,u.importJWK)(f.epk,e);let i,l;if(void 0!==f.apu){if("string"!=typeof f.apu)throw new c.JWEInvalid('JOSE Header "apu" (Agreement PartyUInfo) invalid');i=(0,s.decode)(f.apu)}if(void 0!==f.apv){if("string"!=typeof f.apv)throw new c.JWEInvalid('JOSE Header "apv" (Agreement PartyVInfo) invalid');l=(0,s.decode)(f.apv)}const h=await a.deriveKey(o,t,"ECDH-ES"===e?f.enc:e,"ECDH-ES"===e?(0,d.bitLength)(f.enc):parseInt(e.slice(-5,-2),10),i,l);if("ECDH-ES"===e)return h;if(void 0===r)throw new c.JWEInvalid("JWE Encrypted Key missing");return(0,n.unwrap)(e.slice(-6),h,r)}case"RSA1_5":case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":if(void 0===r)throw new c.JWEInvalid("JWE Encrypted Key missing");return(0,i.decrypt)(e,t,r);case"PBES2-HS256+A128KW":case"PBES2-HS384+A192KW":case"PBES2-HS512+A256KW":if(void 0===r)throw new c.JWEInvalid("JWE Encrypted Key missing");if("number"!=typeof f.p2c)throw new c.JWEInvalid('JOSE Header "p2c" (PBES2 Count) missing or invalid');if("string"!=typeof f.p2s)throw new c.JWEInvalid('JOSE Header "p2s" (PBES2 Salt) missing or invalid');return(0,o.decrypt)(e,t,r,f.p2c,(0,s.decode)(f.p2s));case"A128KW":case"A192KW":case"A256KW":if(void 0===r)throw new c.JWEInvalid("JWE Encrypted Key missing");return(0,n.unwrap)(e,t,r);case"A128GCMKW":case"A192GCMKW":case"A256GCMKW":{if(void 0===r)throw new c.JWEInvalid("JWE Encrypted Key missing");if("string"!=typeof f.iv)throw new c.JWEInvalid('JOSE Header "iv" (Initialization Vector) missing or invalid');if("string"!=typeof f.tag)throw new c.JWEInvalid('JOSE Header "tag" (Authentication Tag) missing or invalid');const n=(0,s.decode)(f.iv),a=(0,s.decode)(f.tag);return(0,h.unwrap)(e,t,r,n,a)}default:throw new c.JOSENotSupported('Invalid or unsupported "alg" (JWE Algorithm) header value')}}},8751:(e,t,r)=>{"use strict";r.d(t,{default:()=>h});var n=r(4714),a=r(5193),o=r(4230),i=r(2453),s=r(9166),c=r(1002),d=r(8842),u=r(2531),l=r(2200),p=r(1897);const h=async function(e,t,r,h,f={}){let y,w,g;switch((0,l.default)(e,r,"encrypt"),e){case"dir":g=r;break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":{if(!a.ecdhAllowed(r))throw new d.JOSENotSupported("ECDH with the provided key is not allowed or not supported by your javascript runtime");const{apu:o,apv:i}=f;let{epk:l}=f;l||(l=(await a.generateEpk(r)).privateKey);const{x:p,y:m,crv:S,kty:E}=await(0,u.exportJWK)(l),v=await a.deriveKey(r,l,"ECDH-ES"===e?t:e,"ECDH-ES"===e?(0,c.bitLength)(t):parseInt(e.slice(-5,-2),10),o,i);if(w={epk:{x:p,crv:S,kty:E}},"EC"===E&&(w.epk.y=m),o&&(w.apu=(0,s.encode)(o)),i&&(w.apv=(0,s.encode)(i)),"ECDH-ES"===e){g=v;break}g=h||(0,c.default)(t);const A=e.slice(-6);y=await(0,n.wrap)(A,v,g);break}case"RSA1_5":case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":g=h||(0,c.default)(t),y=await(0,i.encrypt)(e,r,g);break;case"PBES2-HS256+A128KW":case"PBES2-HS384+A192KW":case"PBES2-HS512+A256KW":{g=h||(0,c.default)(t);const{p2c:n,p2s:a}=f;({encryptedKey:y,...w}=await(0,o.encrypt)(e,r,g,n,a));break}case"A128KW":case"A192KW":case"A256KW":g=h||(0,c.default)(t),y=await(0,n.wrap)(e,r,g);break;case"A128GCMKW":case"A192GCMKW":case"A256GCMKW":{g=h||(0,c.default)(t);const{iv:n}=f;({encryptedKey:y,...w}=await(0,p.wrap)(e,r,g,n));break}default:throw new d.JOSENotSupported('Invalid or unsupported "alg" (JWE Algorithm) header value')}return{cek:g,encryptedKey:y,parameters:w}}},4925:(e,t,r)=>{"use strict";r.d(t,{default:()=>n});const n=e=>Math.floor(e.getTime()/1e3)},8812:(e,t,r)=>{"use strict";r.d(t,{default:()=>n});const n=(e,t)=>`-----BEGIN ${t}-----\n${(e.match(/.{1,64}/g)||[]).join("\n")}\n-----END ${t}-----`},3114:(e,t,r)=>{"use strict";r.d(t,{default:()=>n});const n=(e,...t)=>{let r="Key must be ";if(t.length>2){const e=t.pop();r+=`one of type ${t.join(", ")}, or ${e}.`}else 2===t.length?r+=`one of type ${t[0]} or ${t[1]}.`:r+=`of type ${t[0]}.`;return null==e?r+=` Received ${e}`:"function"==typeof e&&e.name?r+=` Received function ${e.name}`:"object"==typeof e&&null!=e&&e.constructor&&e.constructor.name&&(r+=` Received an instance of ${e.constructor.name}`),r}},2085:(e,t,r)=>{"use strict";r.d(t,{default:()=>n});const n=(...e)=>{const t=e.filter(Boolean);if(0===t.length||1===t.length)return!0;let r;for(const e of t){const t=Object.keys(e);if(r&&0!==r.size)for(const e of t){if(r.has(e))return!1;r.add(e)}else r=new Set(t)}return!0}},2674:(e,t,r)=>{"use strict";function n(e){if("object"!=typeof(t=e)||null===t||"[object Object]"!==Object.prototype.toString.call(e))return!1;var t;if(null===Object.getPrototypeOf(e))return!0;let r=e;for(;null!==Object.getPrototypeOf(r);)r=Object.getPrototypeOf(r);return Object.getPrototypeOf(e)===r}r.d(t,{default:()=>n})},8948:(e,t,r)=>{"use strict";r.d(t,{bitLength:()=>o,default:()=>i});var n=r(8842),a=r(5579);function o(e){switch(e){case"A128GCM":case"A128GCMKW":case"A192GCM":case"A192GCMKW":case"A256GCM":case"A256GCMKW":return 96;case"A128CBC-HS256":case"A192CBC-HS384":case"A256CBC-HS512":return 128;default:throw new n.JOSENotSupported(`Unsupported JWE Algorithm: ${e}`)}}const i=e=>(0,a.default)(new Uint8Array(o(e)>>3))},3358:(e,t,r)=>{"use strict";r.d(t,{default:()=>d});var n=r(8842),a=r(1538),o=r(4925),i=r(7272),s=r(2674);const c=e=>e.toLowerCase().replace(/^application\//,""),d=(e,t,r={})=>{const{typ:d}=r;if(d&&("string"!=typeof e.typ||c(e.typ)!==c(d)))throw new n.JWTClaimValidationFailed('unexpected "typ" JWT header value',"typ","check_failed");let u;try{u=JSON.parse(a.decoder.decode(t))}catch(e){}if(!(0,s.default)(u))throw new n.JWTInvalid("JWT Claims Set must be a top-level JSON object");const{issuer:l}=r;if(l&&!(Array.isArray(l)?l:[l]).includes(u.iss))throw new n.JWTClaimValidationFailed('unexpected "iss" claim value',"iss","check_failed");const{subject:p}=r;if(p&&u.sub!==p)throw new n.JWTClaimValidationFailed('unexpected "sub" claim value',"sub","check_failed");const{audience:h}=r;if(h&&(y="string"==typeof h?[h]:h,!("string"==typeof(f=u.aud)?y.includes(f):Array.isArray(f)&&y.some(Set.prototype.has.bind(new Set(f))))))throw new n.JWTClaimValidationFailed('unexpected "aud" claim value',"aud","check_failed");var f,y;let w;switch(typeof r.clockTolerance){case"string":w=(0,i.default)(r.clockTolerance);break;case"number":w=r.clockTolerance;break;case"undefined":w=0;break;default:throw new TypeError("Invalid clockTolerance option type")}const{currentDate:g}=r,m=(0,o.default)(g||new Date);if(void 0!==u.iat||r.maxTokenAge){if("number"!=typeof u.iat)throw new n.JWTClaimValidationFailed('"iat" claim must be a number',"iat","invalid");if(void 0===u.exp&&u.iat>m+w)throw new n.JWTClaimValidationFailed('"iat" claim timestamp check failed (it should be in the past)',"iat","check_failed")}if(void 0!==u.nbf){if("number"!=typeof u.nbf)throw new n.JWTClaimValidationFailed('"nbf" claim must be a number',"nbf","invalid");if(u.nbf>m+w)throw new n.JWTClaimValidationFailed('"nbf" claim timestamp check failed',"nbf","check_failed")}if(void 0!==u.exp){if("number"!=typeof u.exp)throw new n.JWTClaimValidationFailed('"exp" claim must be a number',"exp","invalid");if(u.exp<=m-w)throw new n.JWTExpired('"exp" claim timestamp check failed',"exp","check_failed")}if(r.maxTokenAge){const e=m-u.iat;if(e-w>("number"==typeof r.maxTokenAge?r.maxTokenAge:(0,i.default)(r.maxTokenAge)))throw new n.JWTExpired('"iat" claim timestamp check failed (too far in the past)',"iat","check_failed");if(e<0-w)throw new n.JWTClaimValidationFailed('"iat" claim timestamp check failed (it should be in the past)',"iat","check_failed")}return u}},7272:(e,t,r)=>{"use strict";r.d(t,{default:()=>a});const n=/^(\d+|\d+\.\d+) ?(seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)$/i,a=e=>{const t=n.exec(e);if(!t)throw new TypeError("Invalid time period format");const r=parseFloat(t[1]);switch(t[2].toLowerCase()){case"sec":case"secs":case"second":case"seconds":case"s":return Math.round(r);case"minute":case"minutes":case"min":case"mins":case"m":return Math.round(60*r);case"hour":case"hours":case"hr":case"hrs":case"h":return Math.round(3600*r);case"day":case"days":case"d":return Math.round(86400*r);case"week":case"weeks":case"w":return Math.round(604800*r);default:return Math.round(31557600*r)}}},5154:(e,t,r)=>{"use strict";r.d(t,{default:()=>n});const n=(e,t)=>{if(void 0!==t&&(!Array.isArray(t)||t.some((e=>"string"!=typeof e))))throw new TypeError(`"${e}" option must be an array of strings`);if(t)return new Set(t)}},3406:(e,t,r)=>{"use strict";r.d(t,{default:()=>a});var n=r(8842);const a=function(e,t,r,a,o){if(void 0!==o.crit&&void 0===a.crit)throw new e('"crit" (Critical) Header Parameter MUST be integrity protected');if(!a||void 0===a.crit)return new Set;if(!Array.isArray(a.crit)||0===a.crit.length||a.crit.some((e=>"string"!=typeof e||0===e.length)))throw new e('"crit" (Critical) Header Parameter MUST be an array of non-empty strings when present');let i;i=void 0!==r?new Map([...Object.entries(r),...t.entries()]):t;for(const t of a.crit){if(!i.has(t))throw new n.JOSENotSupported(`Extension Header Parameter "${t}" is not recognized`);if(void 0===o[t])throw new e(`Extension Header Parameter "${t}" is missing`);if(i.get(t)&&void 0===a[t])throw new e(`Extension Header Parameter "${t}" MUST be integrity protected`)}return new Set(a.crit)}},4714:(e,t,r)=>{"use strict";r.d(t,{unwrap:()=>l,wrap:()=>u});var n=r(6809),a=r(4593),o=r(9492),i=r(3114),s=r(7732);function c(e,t){if(e.algorithm.length!==parseInt(t.slice(1,4),10))throw new TypeError(`Invalid key size for alg: ${t}`)}function d(e,t,r){if((0,a.isCryptoKey)(e))return(0,o.checkEncCryptoKey)(e,t,r),e;if(e instanceof Uint8Array)return a.default.subtle.importKey("raw",e,"AES-KW",!0,[r]);throw new TypeError((0,i.default)(e,...s.types,"Uint8Array"))}const u=async(e,t,r)=>{const o=await d(t,e,"wrapKey");c(o,e);const i=await a.default.subtle.importKey("raw",r,...n.default);return new Uint8Array(await a.default.subtle.wrapKey("raw",i,o,"AES-KW"))},l=async(e,t,r)=>{const o=await d(t,e,"unwrapKey");c(o,e);const i=await a.default.subtle.unwrapKey("raw",r,o,"AES-KW",...n.default);return new Uint8Array(await a.default.subtle.exportKey("raw",i))}},6134:(e,t,r)=>{"use strict";r.d(t,{fromPKCS8:()=>w,fromSPKI:()=>g,toPKCS8:()=>p,toSPKI:()=>l});var n=r(286),a=r(4593),o=r(3114),i=r(9166),s=r(8812),c=r(8842),d=r(7732);const u=async(e,t,r)=>{if(!(0,a.isCryptoKey)(r))throw new TypeError((0,o.default)(r,...d.types));if(!r.extractable)throw new TypeError("CryptoKey is not extractable");if(r.type!==e)throw new TypeError(`key is not a ${e} key`);return(0,s.default)((0,i.encodeBase64)(new Uint8Array(await a.default.subtle.exportKey(t,r))),`${e.toUpperCase()} KEY`)},l=e=>u("public","spki",e),p=e=>u("private","pkcs8",e),h=(e,t,r=0)=>{0===r&&(t.unshift(t.length),t.unshift(6));let n=e.indexOf(t[0],r);if(-1===n)return!1;const a=e.subarray(n,n+t.length);return a.length===t.length&&(a.every(((e,r)=>e===t[r]))||h(e,t,n+1))},f=e=>{switch(!0){case h(e,[42,134,72,206,61,3,1,7]):return"P-256";case h(e,[43,129,4,0,34]):return"P-384";case h(e,[43,129,4,0,35]):return"P-521";case((0,n.isCloudflareWorkers)()||(0,n.isNodeJs)())&&h(e,[43,101,112]):return"Ed25519";case(0,n.isNodeJs)()&&h(e,[43,101,113]):return"Ed448";default:throw new c.JOSENotSupported("Invalid or unsupported EC Key Curve or OKP Key Sub Type")}},y=async(e,t,r,o,i)=>{var s;let d,u;const l=new Uint8Array(atob(r.replace(e,"")).split("").map((e=>e.charCodeAt(0)))),p="spki"===t;switch(o){case"PS256":case"PS384":case"PS512":d={name:"RSA-PSS",hash:`SHA-${o.slice(-3)}`},u=p?["verify"]:["sign"];break;case"RS256":case"RS384":case"RS512":d={name:"RSASSA-PKCS1-v1_5",hash:`SHA-${o.slice(-3)}`},u=p?["verify"]:["sign"];break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":d={name:"RSA-OAEP",hash:`SHA-${parseInt(o.slice(-3),10)||1}`},u=p?["encrypt","wrapKey"]:["decrypt","unwrapKey"];break;case"ES256":d={name:"ECDSA",namedCurve:"P-256"},u=p?["verify"]:["sign"];break;case"ES384":d={name:"ECDSA",namedCurve:"P-384"},u=p?["verify"]:["sign"];break;case"ES512":d={name:"ECDSA",namedCurve:"P-521"},u=p?["verify"]:["sign"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":d={name:"ECDH",namedCurve:f(l)},u=p?[]:["deriveBits"];break;case((0,n.isCloudflareWorkers)()||(0,n.isNodeJs)())&&"EdDSA":const e=f(l).toUpperCase();d={name:`NODE-${e}`,namedCurve:`NODE-${e}`},u=p?["verify"]:["sign"];break;default:throw new c.JOSENotSupported('Invalid or unsupported "alg" (Algorithm) value')}return a.default.subtle.importKey(t,l,d,null!==(s=null==i?void 0:i.extractable)&&void 0!==s&&s,u)},w=(e,t,r)=>y(/(?:-----(?:BEGIN|END) PRIVATE KEY-----|\s)/g,"pkcs8",e,t,r),g=(e,t,r)=>y(/(?:-----(?:BEGIN|END) PUBLIC KEY-----|\s)/g,"spki",e,t,r)},9166:(e,t,r)=>{"use strict";r.d(t,{decode:()=>s,decodeBase64:()=>i,encode:()=>o,encodeBase64:()=>a});var n=r(1538);const a=e=>{let t=e;"string"==typeof t&&(t=n.encoder.encode(t));const r=[];for(let e=0;e<t.length;e+=32768)r.push(String.fromCharCode.apply(null,t.subarray(e,e+32768)));return btoa(r.join(""))},o=e=>a(e).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_"),i=e=>new Uint8Array(atob(e).split("").map((e=>e.charCodeAt(0)))),s=e=>{let t=e;t instanceof Uint8Array&&(t=n.decoder.decode(t)),t=t.replace(/-/g,"+").replace(/_/g,"/").replace(/\s/g,"");try{return i(t)}catch(e){throw new TypeError("The input to be decoded is not correctly encoded.")}}},6809:(e,t,r)=>{"use strict";r.d(t,{default:()=>n});const n=[{hash:"SHA-256",name:"HMAC"},!0,["sign"]]},4869:(e,t,r)=>{"use strict";r.d(t,{default:()=>a});var n=r(8842);const a=(e,t)=>{if(e.length<<3!==t)throw new n.JWEInvalid("Invalid Content Encryption Key length")}},9066:(e,t,r)=>{"use strict";r.d(t,{default:()=>n});const n=(e,t)=>{if(e.startsWith("RS")||e.startsWith("PS")){const{modulusLength:r}=t.algorithm;if("number"!=typeof r||r<2048)throw new TypeError(`${e} requires key modulusLength to be 2048 bits or larger`)}}},5790:(e,t,r)=>{"use strict";r.d(t,{default:()=>p});var n=r(1538),a=r(373),o=r(4869),i=r(1627),s=r(8842),c=r(4593),d=r(9492),u=r(3114),l=r(7732);const p=async(e,t,r,p,h,f)=>{if(!((0,c.isCryptoKey)(t)||t instanceof Uint8Array))throw new TypeError((0,u.default)(t,...l.types,"Uint8Array"));switch((0,a.default)(e,p),e){case"A128CBC-HS256":case"A192CBC-HS384":case"A256CBC-HS512":return t instanceof Uint8Array&&(0,o.default)(t,parseInt(e.slice(-3),10)),async function(e,t,r,a,o,d){if(!(t instanceof Uint8Array))throw new TypeError((0,u.default)(t,"Uint8Array"));const l=parseInt(e.slice(1,4),10),p=await c.default.subtle.importKey("raw",t.subarray(l>>3),"AES-CBC",!1,["decrypt"]),h=await c.default.subtle.importKey("raw",t.subarray(0,l>>3),{hash:"SHA-"+(l<<1),name:"HMAC"},!1,["sign"]),f=(0,n.concat)(d,a,r,(0,n.uint64be)(d.length<<3)),y=new Uint8Array((await c.default.subtle.sign("HMAC",h,f)).slice(0,l>>3));let w,g;try{w=(0,i.default)(o,y)}catch(e){}if(!w)throw new s.JWEDecryptionFailed;try{g=new Uint8Array(await c.default.subtle.decrypt({iv:a,name:"AES-CBC"},p,r))}catch(e){}if(!g)throw new s.JWEDecryptionFailed;return g}(e,t,r,p,h,f);case"A128GCM":case"A192GCM":case"A256GCM":return t instanceof Uint8Array&&(0,o.default)(t,parseInt(e.slice(1,4),10)),async function(e,t,r,a,o,i){let u;t instanceof Uint8Array?u=await c.default.subtle.importKey("raw",t,"AES-GCM",!1,["decrypt"]):((0,d.checkEncCryptoKey)(t,e,"decrypt"),u=t);try{return new Uint8Array(await c.default.subtle.decrypt({additionalData:i,iv:a,name:"AES-GCM",tagLength:128},u,(0,n.concat)(r,o)))}catch(e){throw new s.JWEDecryptionFailed}}(e,t,r,p,h,f);default:throw new s.JOSENotSupported("Unsupported JWE Content Encryption Algorithm")}}},183:(e,t,r)=>{"use strict";r.d(t,{default:()=>a});var n=r(4593);const a=async(e,t)=>{const r=`SHA-${e.slice(-3)}`;return new Uint8Array(await n.default.subtle.digest(r,t))}},5193:(e,t,r)=>{"use strict";r.d(t,{deriveKey:()=>c,ecdhAllowed:()=>u,generateEpk:()=>d});var n=r(1538),a=r(4593),o=r(9492),i=r(3114),s=r(7732);async function c(e,t,r,c,d=new Uint8Array(0),u=new Uint8Array(0)){if(!(0,a.isCryptoKey)(e))throw new TypeError((0,i.default)(e,...s.types));if((0,o.checkEncCryptoKey)(e,"ECDH"),!(0,a.isCryptoKey)(t))throw new TypeError((0,i.default)(t,...s.types));(0,o.checkEncCryptoKey)(t,"ECDH","deriveBits");const l=(0,n.concat)((0,n.lengthAndInput)(n.encoder.encode(r)),(0,n.lengthAndInput)(d),(0,n.lengthAndInput)(u),(0,n.uint32be)(c)),p=new Uint8Array(await a.default.subtle.deriveBits({name:"ECDH",public:e},t,Math.ceil(parseInt(t.algorithm.namedCurve.slice(-3),10)/8)<<3));return(0,n.concatKdf)(p,c,l)}async function d(e){if(!(0,a.isCryptoKey)(e))throw new TypeError((0,i.default)(e,...s.types));return a.default.subtle.generateKey(e.algorithm,!0,["deriveBits"])}function u(e){if(!(0,a.isCryptoKey)(e))throw new TypeError((0,i.default)(e,...s.types));return["P-256","P-384","P-521"].includes(e.algorithm.namedCurve)}},1088:(e,t,r)=>{"use strict";r.d(t,{default:()=>l});var n=r(1538),a=r(373),o=r(4869),i=r(4593),s=r(9492),c=r(3114),d=r(8842),u=r(7732);const l=async(e,t,r,l,p)=>{if(!((0,i.isCryptoKey)(r)||r instanceof Uint8Array))throw new TypeError((0,c.default)(r,...u.types,"Uint8Array"));switch((0,a.default)(e,l),e){case"A128CBC-HS256":case"A192CBC-HS384":case"A256CBC-HS512":return r instanceof Uint8Array&&(0,o.default)(r,parseInt(e.slice(-3),10)),async function(e,t,r,a,o){if(!(r instanceof Uint8Array))throw new TypeError((0,c.default)(r,"Uint8Array"));const s=parseInt(e.slice(1,4),10),d=await i.default.subtle.importKey("raw",r.subarray(s>>3),"AES-CBC",!1,["encrypt"]),u=await i.default.subtle.importKey("raw",r.subarray(0,s>>3),{hash:"SHA-"+(s<<1),name:"HMAC"},!1,["sign"]),l=new Uint8Array(await i.default.subtle.encrypt({iv:a,name:"AES-CBC"},d,t)),p=(0,n.concat)(o,a,l,(0,n.uint64be)(o.length<<3));return{ciphertext:l,tag:new Uint8Array((await i.default.subtle.sign("HMAC",u,p)).slice(0,s>>3))}}(e,t,r,l,p);case"A128GCM":case"A192GCM":case"A256GCM":return r instanceof Uint8Array&&(0,o.default)(r,parseInt(e.slice(1,4),10)),async function(e,t,r,n,a){let o;r instanceof Uint8Array?o=await i.default.subtle.importKey("raw",r,"AES-GCM",!1,["encrypt"]):((0,s.checkEncCryptoKey)(r,e,"encrypt"),o=r);const c=new Uint8Array(await i.default.subtle.encrypt({additionalData:a,iv:n,name:"AES-GCM",tagLength:128},o,t)),d=c.slice(-16);return{ciphertext:c.slice(0,-16),tag:d}}(e,t,r,l,p);default:throw new d.JOSENotSupported("Unsupported JWE Content Encryption Algorithm")}}},286:(e,t,r)=>{"use strict";function n(){return"function"==typeof WebSocketPair}function a(){try{return void 0!==process.versions.node}catch(e){return!1}}r.d(t,{isCloudflareWorkers:()=>n,isNodeJs:()=>a})},6931:(e,t,r)=>{"use strict";r.d(t,{default:()=>a});var n=r(8842);const a=async(e,t)=>{let r,a,o=!1;"function"==typeof AbortController&&(r=new AbortController,a=setTimeout((()=>{o=!0,r.abort()}),t));const i=await fetch(e.href,{signal:r?r.signal:void 0,redirect:"manual"}).catch((e=>{if(o)throw new n.JWKSTimeout;throw e}));if(void 0!==a&&clearTimeout(a),200!==i.status)throw new n.JOSEError("Expected 200 OK from the JSON Web Key Set HTTP response");try{return await i.json()}catch(e){throw new n.JOSEError("Failed to parse the JSON Web Key Set HTTP response as JSON")}}},7957:(e,t,r)=>{"use strict";r.d(t,{generateKeyPair:()=>d,generateSecret:()=>s});var n=r(286),a=r(4593),o=r(8842),i=r(5579);async function s(e,t){var r;let n,s,c;switch(e){case"HS256":case"HS384":case"HS512":n=parseInt(e.slice(-3),10),s={name:"HMAC",hash:`SHA-${n}`,length:n},c=["sign","verify"];break;case"A128CBC-HS256":case"A192CBC-HS384":case"A256CBC-HS512":return n=parseInt(e.slice(-3),10),(0,i.default)(new Uint8Array(n>>3));case"A128KW":case"A192KW":case"A256KW":n=parseInt(e.slice(1,4),10),s={name:"AES-KW",length:n},c=["wrapKey","unwrapKey"];break;case"A128GCMKW":case"A192GCMKW":case"A256GCMKW":case"A128GCM":case"A192GCM":case"A256GCM":n=parseInt(e.slice(1,4),10),s={name:"AES-GCM",length:n},c=["encrypt","decrypt"];break;default:throw new o.JOSENotSupported('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}return a.default.subtle.generateKey(s,null!==(r=null==t?void 0:t.extractable)&&void 0!==r&&r,c)}function c(e){var t;const r=null!==(t=null==e?void 0:e.modulusLength)&&void 0!==t?t:2048;if("number"!=typeof r||r<2048)throw new o.JOSENotSupported("Invalid or unsupported modulusLength option provided, 2048 bits or larger keys must be used");return r}async function d(e,t){var r,i;let s,d;switch(e){case"PS256":case"PS384":case"PS512":s={name:"RSA-PSS",hash:`SHA-${e.slice(-3)}`,publicExponent:new Uint8Array([1,0,1]),modulusLength:c(t)},d=["sign","verify"];break;case"RS256":case"RS384":case"RS512":s={name:"RSASSA-PKCS1-v1_5",hash:`SHA-${e.slice(-3)}`,publicExponent:new Uint8Array([1,0,1]),modulusLength:c(t)},d=["sign","verify"];break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":s={name:"RSA-OAEP",hash:`SHA-${parseInt(e.slice(-3),10)||1}`,publicExponent:new Uint8Array([1,0,1]),modulusLength:c(t)},d=["decrypt","unwrapKey","encrypt","wrapKey"];break;case"ES256":s={name:"ECDSA",namedCurve:"P-256"},d=["sign","verify"];break;case"ES384":s={name:"ECDSA",namedCurve:"P-384"},d=["sign","verify"];break;case"ES512":s={name:"ECDSA",namedCurve:"P-521"},d=["sign","verify"];break;case((0,n.isCloudflareWorkers)()||(0,n.isNodeJs)())&&"EdDSA":switch(null==t?void 0:t.crv){case void 0:case"Ed25519":s={name:"NODE-ED25519",namedCurve:"NODE-ED25519"},d=["sign","verify"];break;case(0,n.isNodeJs)()&&"Ed448":s={name:"NODE-ED448",namedCurve:"NODE-ED448"},d=["sign","verify"];break;default:throw new o.JOSENotSupported("Invalid or unsupported crv option provided, supported values are Ed25519 and Ed448")}break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":s={name:"ECDH",namedCurve:null!==(r=null==t?void 0:t.crv)&&void 0!==r?r:"P-256"},d=["deriveKey","deriveBits"];break;default:throw new o.JOSENotSupported('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}return a.default.subtle.generateKey(s,null!==(i=null==t?void 0:t.extractable)&&void 0!==i&&i,d)}},3441:(e,t,r)=>{"use strict";r.d(t,{default:()=>s});var n=r(4593),a=r(9492),o=r(3114),i=r(7732);function s(e,t,r){if((0,n.isCryptoKey)(t))return(0,a.checkSigCryptoKey)(t,e,r),t;if(t instanceof Uint8Array){if(!e.startsWith("HS"))throw new TypeError((0,o.default)(t,...i.types));return n.default.subtle.importKey("raw",t,{hash:`SHA-${e.slice(-3)}`,name:"HMAC"},!1,[r])}throw new TypeError((0,o.default)(t,...i.types,"Uint8Array"))}},7732:(e,t,r)=>{"use strict";r.d(t,{default:()=>a,types:()=>o});var n=r(4593);const a=e=>(0,n.isCryptoKey)(e),o=["CryptoKey"]},6604:(e,t,r)=>{"use strict";r.d(t,{default:()=>s});var n=r(286),a=r(4593),o=r(8842),i=r(9166);const s=async e=>{var t,r;const{algorithm:s,keyUsages:c}=function(e){let t,r;switch(e.kty){case"oct":switch(e.alg){case"HS256":case"HS384":case"HS512":t={name:"HMAC",hash:`SHA-${e.alg.slice(-3)}`},r=["sign","verify"];break;case"A128CBC-HS256":case"A192CBC-HS384":case"A256CBC-HS512":throw new o.JOSENotSupported(`${e.alg} keys cannot be imported as CryptoKey instances`);case"A128GCM":case"A192GCM":case"A256GCM":case"A128GCMKW":case"A192GCMKW":case"A256GCMKW":t={name:"AES-GCM"},r=["encrypt","decrypt"];break;case"A128KW":case"A192KW":case"A256KW":t={name:"AES-KW"},r=["wrapKey","unwrapKey"];break;case"PBES2-HS256+A128KW":case"PBES2-HS384+A192KW":case"PBES2-HS512+A256KW":t={name:"PBKDF2"},r=["deriveBits"];break;default:throw new o.JOSENotSupported('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break;case"RSA":switch(e.alg){case"PS256":case"PS384":case"PS512":t={name:"RSA-PSS",hash:`SHA-${e.alg.slice(-3)}`},r=e.d?["sign"]:["verify"];break;case"RS256":case"RS384":case"RS512":t={name:"RSASSA-PKCS1-v1_5",hash:`SHA-${e.alg.slice(-3)}`},r=e.d?["sign"]:["verify"];break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":t={name:"RSA-OAEP",hash:`SHA-${parseInt(e.alg.slice(-3),10)||1}`},r=e.d?["decrypt","unwrapKey"]:["encrypt","wrapKey"];break;default:throw new o.JOSENotSupported('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break;case"EC":switch(e.alg){case"ES256":t={name:"ECDSA",namedCurve:"P-256"},r=e.d?["sign"]:["verify"];break;case"ES384":t={name:"ECDSA",namedCurve:"P-384"},r=e.d?["sign"]:["verify"];break;case"ES512":t={name:"ECDSA",namedCurve:"P-521"},r=e.d?["sign"]:["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":t={name:"ECDH",namedCurve:e.crv},r=e.d?["deriveBits"]:[];break;default:throw new o.JOSENotSupported('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break;case((0,n.isCloudflareWorkers)()||(0,n.isNodeJs)())&&"OKP":if("EdDSA"!==e.alg)throw new o.JOSENotSupported('Invalid or unsupported JWK "alg" (Algorithm) Parameter value');switch(e.crv){case"Ed25519":t={name:"NODE-ED25519",namedCurve:"NODE-ED25519"},r=e.d?["sign"]:["verify"];break;case(0,n.isNodeJs)()&&"Ed448":t={name:"NODE-ED448",namedCurve:"NODE-ED448"},r=e.d?["sign"]:["verify"];break;default:throw new o.JOSENotSupported('Invalid or unsupported JWK "crv" (Subtype of Key Pair) Parameter value')}break;default:throw new o.JOSENotSupported('Invalid or unsupported JWK "kty" (Key Type) Parameter value')}return{algorithm:t,keyUsages:r}}(e),d=[s,null!==(t=e.ext)&&void 0!==t&&t,null!==(r=e.key_ops)&&void 0!==r?r:c];if("PBKDF2"===s.name)return a.default.subtle.importKey("raw",(0,i.decode)(e.k),...d);const u={...e};return delete u.alg,a.default.subtle.importKey("jwk",u,...d)}},1858:(e,t,r)=>{"use strict";r.d(t,{default:()=>s});var n=r(4593),a=r(3114),o=r(9166),i=r(7732);const s=async e=>{if(e instanceof Uint8Array)return{kty:"oct",k:(0,o.encode)(e)};if(!(0,n.isCryptoKey)(e))throw new TypeError((0,a.default)(e,...i.types,"Uint8Array"));if(!e.extractable)throw new TypeError("non-extractable CryptoKey cannot be exported as a JWK");const{ext:t,key_ops:r,alg:s,use:c,...d}=await n.default.subtle.exportKey("jwk",e);return d}},4230:(e,t,r)=>{"use strict";r.d(t,{decrypt:()=>f,encrypt:()=>h});var n=r(5579),a=r(1538),o=r(9166),i=r(4714),s=r(4044),c=r(4593),d=r(9492),u=r(3114),l=r(7732);async function p(e,t,r,n){(0,s.default)(e);const o=(0,a.p2s)(t,e),i=parseInt(t.slice(13,16),10),p={hash:`SHA-${t.slice(8,11)}`,iterations:r,name:"PBKDF2",salt:o},h={length:i,name:"AES-KW"},f=await function(e,t){if(e instanceof Uint8Array)return c.default.subtle.importKey("raw",e,"PBKDF2",!1,["deriveBits"]);if((0,c.isCryptoKey)(e))return(0,d.checkEncCryptoKey)(e,t,"deriveBits","deriveKey"),e;throw new TypeError((0,u.default)(e,...l.types,"Uint8Array"))}(n,t);if(f.usages.includes("deriveBits"))return new Uint8Array(await c.default.subtle.deriveBits(p,f,i));if(f.usages.includes("deriveKey"))return c.default.subtle.deriveKey(p,f,h,!1,["wrapKey","unwrapKey"]);throw new TypeError('PBKDF2 key "usages" must include "deriveBits" or "deriveKey"')}const h=async(e,t,r,a=2048,s=(0,n.default)(new Uint8Array(16)))=>{const c=await p(s,e,a,t);return{encryptedKey:await(0,i.wrap)(e.slice(-6),c,r),p2c:a,p2s:(0,o.encode)(s)}},f=async(e,t,r,n,a)=>{const o=await p(a,e,n,t);return(0,i.unwrap)(e.slice(-6),o,r)}},5579:(e,t,r)=>{"use strict";r.d(t,{default:()=>a});var n=r(4593);const a=n.default.getRandomValues.bind(n.default)},2453:(e,t,r)=>{"use strict";r.d(t,{decrypt:()=>l,encrypt:()=>u});var n=r(4067),a=r(6809),o=r(4593),i=r(9492),s=r(9066),c=r(3114),d=r(7732);const u=async(e,t,r)=>{if(!(0,o.isCryptoKey)(t))throw new TypeError((0,c.default)(t,...d.types));if((0,i.checkEncCryptoKey)(t,e,"encrypt","wrapKey"),(0,s.default)(e,t),t.usages.includes("encrypt"))return new Uint8Array(await o.default.subtle.encrypt((0,n.default)(e),t,r));if(t.usages.includes("wrapKey")){const i=await o.default.subtle.importKey("raw",r,...a.default);return new Uint8Array(await o.default.subtle.wrapKey("raw",i,t,(0,n.default)(e)))}throw new TypeError('RSA-OAEP key "usages" must include "encrypt" or "wrapKey" for this operation')},l=async(e,t,r)=>{if(!(0,o.isCryptoKey)(t))throw new TypeError((0,c.default)(t,...d.types));if((0,i.checkEncCryptoKey)(t,e,"decrypt","unwrapKey"),(0,s.default)(e,t),t.usages.includes("decrypt"))return new Uint8Array(await o.default.subtle.decrypt((0,n.default)(e),t,r));if(t.usages.includes("unwrapKey")){const i=await o.default.subtle.unwrapKey("raw",r,t,(0,n.default)(e),...a.default);return new Uint8Array(await o.default.subtle.exportKey("raw",i))}throw new TypeError('RSA-OAEP key "usages" must include "decrypt" or "unwrapKey" for this operation')}},3736:(e,t,r)=>{"use strict";r.d(t,{default:()=>s});var n=r(6185),a=r(4593),o=r(9066),i=r(3441);const s=async(e,t,r)=>{const s=await(0,i.default)(e,t,"sign");(0,o.default)(e,s);const c=await a.default.subtle.sign((0,n.default)(e,s.algorithm),s,r);return new Uint8Array(c)}},6185:(e,t,r)=>{"use strict";r.d(t,{default:()=>o});var n=r(286),a=r(8842);function o(e,t){const r=`SHA-${e.slice(-3)}`;switch(e){case"HS256":case"HS384":case"HS512":return{hash:r,name:"HMAC"};case"PS256":case"PS384":case"PS512":return{hash:r,name:"RSA-PSS",saltLength:e.slice(-3)>>3};case"RS256":case"RS384":case"RS512":return{hash:r,name:"RSASSA-PKCS1-v1_5"};case"ES256":case"ES384":case"ES512":return{hash:r,name:"ECDSA",namedCurve:t.namedCurve};case((0,n.isCloudflareWorkers)()||(0,n.isNodeJs)())&&"EdDSA":const{namedCurve:o}=t;return{name:o,namedCurve:o};default:throw new a.JOSENotSupported(`alg ${e} is not supported either by JOSE or your javascript runtime`)}}},4067:(e,t,r)=>{"use strict";r.d(t,{default:()=>a});var n=r(8842);function a(e){switch(e){case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":return"RSA-OAEP";default:throw new n.JOSENotSupported(`alg ${e} is not supported either by JOSE or your javascript runtime`)}}},1627:(e,t,r)=>{"use strict";r.d(t,{default:()=>n});const n=(e,t)=>{if(!(e instanceof Uint8Array))throw new TypeError("First argument must be a buffer");if(!(t instanceof Uint8Array))throw new TypeError("Second argument must be a buffer");if(e.length!==t.length)throw new TypeError("Input buffers must have the same length");const r=e.length;let n=0,a=-1;for(;++a<r;)n|=e[a]^t[a];return 0===n}},6239:(e,t,r)=>{"use strict";r.d(t,{default:()=>s});var n=r(6185),a=r(4593),o=r(9066),i=r(3441);const s=async(e,t,r,s)=>{const c=await(0,i.default)(e,t,"verify");(0,o.default)(e,c);const d=(0,n.default)(e,c.algorithm);try{return await a.default.subtle.verify(d,c,r,s)}catch(e){return!1}}},4593:(e,t,r)=>{"use strict";r.d(t,{default:()=>n,isCryptoKey:()=>a});const n=crypto;function a(e){try{return null!=e&&"boolean"==typeof e.extractable&&"string"==typeof e.algorithm.name&&"string"==typeof e.type}catch(e){return!1}}},5515:(e,t,r)=>{"use strict";r.d(t,{deflate:()=>o,inflate:()=>a});var n=r(8842);const a=async()=>{throw new n.JOSENotSupported('JWE "zip" (Compression Algorithm) Header Parameter is not supported by your javascript runtime. You need to use the `inflateRaw` decrypt option to provide Inflate Raw implementation.')},o=async()=>{throw new n.JOSENotSupported('JWE "zip" (Compression Algorithm) Header Parameter is not supported by your javascript runtime. You need to use the `deflateRaw` encrypt option to provide Deflate Raw implementation.')}},6001:(e,t,r)=>{"use strict";r.r(t),r.d(t,{decode:()=>o,encode:()=>a});var n=r(9166);const a=n.encode,o=n.decode},7879:(e,t,r)=>{"use strict";r.d(t,{decodeJwt:()=>s});var n=r(6001),a=r(1538),o=r(2674),i=r(8842);function s(e){if("string"!=typeof e)throw new i.JWTInvalid("JWTs must use Compact JWS serialization, JWT must be a string");const{1:t,length:r}=e.split(".");if(5===r)throw new i.JWTInvalid("Only JWTs using Compact JWS serialization can be decoded");if(3!==r)throw new i.JWTInvalid("Invalid JWT");if(!t)throw new i.JWTInvalid("JWTs must contain a payload");let s,c;try{s=(0,n.decode)(t)}catch(e){throw new i.JWTInvalid("Failed to parse the base64url encoded payload")}try{c=JSON.parse(a.decoder.decode(s))}catch(e){throw new i.JWTInvalid("Failed to parse the decoded payload as JSON")}if(!(0,o.default)(c))throw new i.JWTInvalid("Invalid JWT Claims Set");return c}},3878:(e,t,r)=>{"use strict";r.d(t,{decodeProtectedHeader:()=>i});var n=r(6001),a=r(1538),o=r(2674);function i(e){let t;if("string"==typeof e){const r=e.split(".");3!==r.length&&5!==r.length||([t]=r)}else if("object"==typeof e&&e){if(!("protected"in e))throw new TypeError("Token does not contain a Protected Header");t=e.protected}try{if("string"!=typeof t||!t)throw new Error;const e=JSON.parse(a.decoder.decode((0,n.decode)(t)));if(!(0,o.default)(e))throw new Error;return e}catch(e){throw new TypeError("Invalid Token or Protected Header formatting")}}},8842:(e,t,r)=>{"use strict";r.r(t),r.d(t,{JOSEAlgNotAllowed:()=>i,JOSEError:()=>n,JOSENotSupported:()=>s,JWEDecryptionFailed:()=>c,JWEInvalid:()=>d,JWKInvalid:()=>p,JWKSInvalid:()=>h,JWKSMultipleMatchingKeys:()=>y,JWKSNoMatchingKey:()=>f,JWKSTimeout:()=>w,JWSInvalid:()=>u,JWSSignatureVerificationFailed:()=>g,JWTClaimValidationFailed:()=>a,JWTExpired:()=>o,JWTInvalid:()=>l});class n extends Error{constructor(e){var t;super(e),this.code="ERR_JOSE_GENERIC",this.name=this.constructor.name,null===(t=Error.captureStackTrace)||void 0===t||t.call(Error,this,this.constructor)}static get code(){return"ERR_JOSE_GENERIC"}}class a extends n{constructor(e,t="unspecified",r="unspecified"){super(e),this.code="ERR_JWT_CLAIM_VALIDATION_FAILED",this.claim=t,this.reason=r}static get code(){return"ERR_JWT_CLAIM_VALIDATION_FAILED"}}class o extends n{constructor(e,t="unspecified",r="unspecified"){super(e),this.code="ERR_JWT_EXPIRED",this.claim=t,this.reason=r}static get code(){return"ERR_JWT_EXPIRED"}}class i extends n{constructor(){super(...arguments),this.code="ERR_JOSE_ALG_NOT_ALLOWED"}static get code(){return"ERR_JOSE_ALG_NOT_ALLOWED"}}class s extends n{constructor(){super(...arguments),this.code="ERR_JOSE_NOT_SUPPORTED"}static get code(){return"ERR_JOSE_NOT_SUPPORTED"}}class c extends n{constructor(){super(...arguments),this.code="ERR_JWE_DECRYPTION_FAILED",this.message="decryption operation failed"}static get code(){return"ERR_JWE_DECRYPTION_FAILED"}}class d extends n{constructor(){super(...arguments),this.code="ERR_JWE_INVALID"}static get code(){return"ERR_JWE_INVALID"}}class u extends n{constructor(){super(...arguments),this.code="ERR_JWS_INVALID"}static get code(){return"ERR_JWS_INVALID"}}class l extends n{constructor(){super(...arguments),this.code="ERR_JWT_INVALID"}static get code(){return"ERR_JWT_INVALID"}}class p extends n{constructor(){super(...arguments),this.code="ERR_JWK_INVALID"}static get code(){return"ERR_JWK_INVALID"}}class h extends n{constructor(){super(...arguments),this.code="ERR_JWKS_INVALID"}static get code(){return"ERR_JWKS_INVALID"}}class f extends n{constructor(){super(...arguments),this.code="ERR_JWKS_NO_MATCHING_KEY",this.message="no applicable key found in the JSON Web Key Set"}static get code(){return"ERR_JWKS_NO_MATCHING_KEY"}}class y extends n{constructor(){super(...arguments),this.code="ERR_JWKS_MULTIPLE_MATCHING_KEYS",this.message="multiple matching keys found in the JSON Web Key Set"}static get code(){return"ERR_JWKS_MULTIPLE_MATCHING_KEYS"}}class w extends n{constructor(){super(...arguments),this.code="ERR_JWKS_TIMEOUT",this.message="request timed out"}static get code(){return"ERR_JWKS_TIMEOUT"}}class g extends n{constructor(){super(...arguments),this.code="ERR_JWS_SIGNATURE_VERIFICATION_FAILED",this.message="signature verification failed"}static get code(){return"ERR_JWS_SIGNATURE_VERIFICATION_FAILED"}}}},t={};function r(n){var a=t[n];if(void 0!==a)return a.exports;var o=t[n]={exports:{}};return e[n](o,o.exports,r),o.exports}r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var n=r(1769);window.FHIR=n})();
//# sourceMappingURL=fhir-client.pure.min.js.map